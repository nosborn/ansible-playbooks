---
- name: Gather facts
  hosts: all

  pre_tasks:
    - name: gather facts from excluded hosts
      ansible.builtin.setup: {}
      delegate_to: "{{ item }}"
      delegate_facts: true
      loop: "{{ groups['all'] }}"
      when: item not in ansible_play_hosts
      run_once: true
      tags:
        - always

- name: Alpine Linux early configuration
  hosts:
    - proxy_gb
    - proxy_in
    - tombstone
  gather_facts: false

  pre_tasks:
    - name: configure repositories
      ansible.builtin.copy:
        content: "{{ apk_repositories }}"
        dest: /etc/apk/repositories
        owner: root
        group: root
        mode: !!str 0444
      tags:
        - always

    - name: update repositories
      community.general.apk:
        update_cache: true
      changed_when: false
      tags:
        - always

    - name: install prerequisite packages
      ansible.builtin.package:
        name:
          - acl
        state: latest
      register: result
      until: result is not failed
      tags:
        - always

    - name: configure networking
      ansible.builtin.copy:
        content: "{{ network_interfaces }}"
        dest: /etc/network/interfaces
        owner: root
        group: root
        mode: !!str 0444
      # notify: restart networking -- FIXME

  roles:
    - role: iptables
      when: ansible_hostname != 'tombstone'
      tags:
        - always
    - role: ufw
      tags:
        - always
    - role: wireguard
      when: ansible_hostname != 'tombstone'
      tags:
        - always

  # handlers:
  #   - name: restart networking
  #     ansible.builtin.service:
  #       name: networking
  #       state: restarted

- name: Alpine Linux common configuration
  hosts:
    - proxy_gb
    - proxy_in
    - tombstone
  gather_facts: false

  roles:
    - role: apk_cron
    - role: chrony
    - role: node_exporter
    - role: openrc_exporter
    - role: promtail
    - role: sshd
      tags:
        - sshd
    - role: tcpdump
    - role: unbound
      tags:
        - unbound

- name: Configure Tombstone
  hosts:
    - tombstone
  gather_facts: false

  roles:
    - role: alertmanager
    - role: blackbox_exporter
    - role: dns_updater
      tags:
        - dns-updater
    - role: grafana
    - role: homebridge
      tags:
        - homebridge
    - role: imapfilter
      tags:
        - imapfilter
    - role: loki
    - role: man_pages
    - role: microcode
    - role: prometheus
    - role: step_ca

- name: Configure proxies
  hosts:
    - proxy_gb
    - proxy_in
  gather_facts: false

  pre_tasks:
    - name: disable cloud-init network configuration
      ansible.builtin.copy:
        content: |
          network: {config: disabled}
        dest: /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg
        owner: root
        group: root
        mode: !!str 0444
      tags:
        - always

  roles:
    - role: nginx
      tags:
        - nginx
    - role: wireguard_exporter

# - name: Configure CloudKey
#   hosts: cloudkey
#   gather_facts: false
#
#   roles:
#     - role: unifi

- name: Configure Gateway
  hosts: gateway
  gather_facts: false

  roles:
    - role: unifi_gateway
      when: false
