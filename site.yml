# yamllint disable rule:line-length
---
- hosts: tombstone

  pre_tasks:
    - name: configure networking
      ansible.builtin.copy:
        content: |
          inet {{ lan_ipv4_address }} {{ lan_ipv4_subnet | ipaddr('netmask') }} NONE
          inet6 autoconf
        dest: /etc/hostname.{{ lan_if }}
        owner: root
        group: wheel
        mode: 0440
      notify: restart networking

    - name: set default gateway
      ansible.builtin.copy:
        content: |
          192.168.1.1
        dest: /etc/mygate
        owner: root
        group: wheel
        mode: 0440
      notify: restart networking

    - name: set sysctl variables
      ansible.posix.sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
      loop:
        - name: ddb.panic
          value: 0
        - name: net.inet.ip.forwarding
          value: 1

    - name: set timezone
      ansible.builtin.file:
        path: /etc/localtime
        src: /usr/share/zoneinfo/{{ timezone }}
        state: link

    - name: set /etc/hosts entries
      ansible.builtin.lineinfile:
        path: /etc/hosts
        line: "{{ hostvars['unifi'].lan_ipv4_address }}\tunifi.{{ global_domain }}"

  roles:
    - role: acme_client
    - role: apmd
    - role: homebridge
    - role: monit
    - role: nginx
    - role: ntpd
    - role: pf
    - role: smtpd
    - role: sndiod
    - role: sysclean
    - role: tor
    - role: unbound
      tags:
        - unbound

  tasks:
    - name: sysmerge exclusions
      ansible.builtin.copy:
        content: |
          /etc/mail/aliases
          /etc/mail/smtpd.conf
          /etc/monitrc
          /etc/ntpd.conf
          /etc/pf.conf
          /etc/tor/torrc
          /etc/ttys
          /var/unbound/etc/unbound.conf
        dest: /etc/sysmerge.ignore
        owner: root
        group: wheel
        mode: 0444

  handlers:
    - name: restart networking
      ansible.builtin.command:
        argv:
          - /bin/sh
          - /etc/netstart

- hosts: unifi

  roles:
    - role: unifi

- hosts: usg

  tasks:
    - name: install script to mangle TTL with iptables
      ansible.builtin.template:
        src: post-config.d/iptables_ttl_mangle.sh.j2
        dest: /config/scripts/post-config.d/iptables_ttl_mangle.sh
        owner: root
        group: vyattacfg
        mode: 0755
        validate: /bin/sh -n %s
      notify: iptables mangle ttl

    - name: set allowed interfaces for avahi
      ansible.builtin.lineinfile:
        path: /etc/avahi/avahi-daemon.conf
        regexp: allow-interfaces=
        line: allow-interfaces={{ lan_if }},{{ iot_if }}
      notify: restart avahi-daemon

    - name: set denied interfaces for avahi
      ansible.builtin.lineinfile:
        path: /etc/avahi/avahi-daemon.conf
        regexp: deny-interfaces=
        line: deny-interfaces={{ wan_if }}
      notify: restart avahi-daemon

  handlers:
    - name: iptables mangle ttl
      ansible.builtin.command:
        argv:
          - /config/scripts/post-config.d/iptables_ttl_mangle.sh

    - name: restart avahi-daemon
      ansible.builtin.service:
        name: avahi-daemon
        state: restarted
