# yamllint disable rule:line-length
---
- name: Gather facts
  hosts: all

  pre_tasks:
    - name: gather facts from excluded hosts
      ansible.builtin.setup:
      delegate_to: "{{ item }}"
      delegate_facts: true
      loop: "{{ groups['all'] }}"
      when: item not in ansible_play_hosts
      run_once: true
      tags:
        - always

- name: Alpine Linux early configuration
  hosts:
    - proxy_gb
    - proxy_in
    - tombstone
  gather_facts: false
  strategy: free

  pre_tasks:
    - name: configure repositories
      ansible.builtin.copy:
        content: "{{ apk_repositories }}"
        dest: /etc/apk/repositories
        owner: root
        group: root
        mode: !!str 0444

    - name: update repositories
      community.general.apk:
        update_cache: true
      changed_when: false

    - name: install prerequisite packages
      ansible.builtin.package:
        name:
          - acl
        state: latest
      register: result
      until: result is not failed

    # - name: set time zone
    #   ansible.builtin.file:
    #     path: /etc/localtime
    #     src: /usr/share/zoneinfo/{{ timezone }}
    #     state: link
    #   tags:
    #     - always

    # - name: configure hosts file
    #   ansible.builtin.lineinfile:
    #     path: /etc/hosts
    #     regexp: "^127\\.0\\.1\\.1\t"
    #     line: "{{ lan_ipv4_address }}\ttombstone.{{ domain_name }}\ttombstone"
    #   tags:
    #     - always

    # - name: configure LAN interface
    #   ansible.builtin.copy:
    #     content: |
    #       inet {{ lan_ipv4_address }} 0xffffff00
    #       inet6 autoconf
    #     dest: /etc/hostname.{{ lan_if }}
    #     owner: root
    #     group: wheel
    #     mode: !!str 0440
    #   notify: netstart lan_if
    #   tags:
    #     - always
    #   when: false

    # - name: restart networking now
    #   ansible.builtin.meta: flush_handlers

    # - name: enable forwarding
    #   ansible.posix.sysctl:
    #     name: "{{ item }}"
    #     value: 1
    #     sysctl_set: true
    #   loop:
    #     - net.inet.ip.forwarding
    #     - net.inet6.ip6.forwarding
    #   tags:
    #     - always

    # - name: configure kernel
    #   ansible.builtin.copy:
    #     content: "{{ kernel_configuration }}"
    #     dest: /etc/bsd.re-config
    #     owner: root
    #     group: wheel
    #     mode: !!str 0444
    #   tags:
    #     - always

    # - name: configure install URL
    #   ansible.builtin.copy:
    #     content: |
    #       https://cloudflare.cdn.openbsd.org/pub/OpenBSD/
    #     dest: /etc/installurl
    #     owner: root
    #     group: wheel
    #     mode: !!str 0444

  roles:
    - role: wireguard

- name: Alpine Linux common configuration
  hosts:
    - proxy_gb
    - proxy_in
    - tombstone
  gather_facts: false
  strategy: free

  roles:
    - role: chrony
    - role: nginx
    - role: node_exporter
    - role: openrc_exporter
    - role: promtail
    - role: sshd
    - role: tcpdump
    - role: ufw
    - role: unbound
    - role: wireguard_exporter

- name: Configure Tombstone
  hosts: tombstone
  gather_facts: false

  roles:
    - role: alertmanager
    - role: blackbox_exporter
      when: false
    - role: grafana
    - role: homebridge
    - role: imapfilter
      when: false
    - role: loki
    - role: microcode
    - role: prometheus

- name: Configure CloudKey
  hosts: cloudkey
  gather_facts: false

  roles:
    - role: unifi

- name: Configure Gateway
  hosts: gateway
  gather_facts: false

  roles:
    - role: unifi_gateway
