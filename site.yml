# site
---
- hosts: mac-mini

  roles:
  # - { role: ssh, tags: ['ssh'] }

- hosts: tombstone

  pre_tasks:

    - name: Default hostname
      copy:
        content="tombstone.{{ global_domain }}\n"
        dest=/etc/myname
        owner=root group=wheel mode=0444

    - name: Host name database
      template:
        src=hosts.j2 dest=/etc/hosts
        owner=root group=wheel mode=0444

    - name: Interface-specific configuration files
      template:
        src=hostname.{{ item }}.j2 dest=/etc/hostname.{{ item }}
        owner=root group=wheel mode=0440
      with_items:
        - "{{ guest_if }}"
        - "{{ lan_if }}"
        - "{{ pppoe_pppoedev }}"
        - "{{ wan_if }}"
        - "{{ wlan_if }}"
      notify: netstart

    - name: Resolver configuration file
      template:
        src=templates/resolv.conf.j2 dest=/etc/resolv.conf
        owner=root group=wheel mode=0444

    - name: System-wide package system configuration
      copy:
        content="{{ installurl }}\n"
        dest=/etc/installurl
        owner=root group=wheel mode=0444

    - meta: flush_handlers

  roles:
    - { role: apmd, tags: ['apmd'] }
    - { role: avahi, tags: ['avahi'] }
    - { role: bwm-ng, tags: ['bwm-ng'] }
  # - c-icap
    - { role: collectd, tags: ['collectd'] }
    - { role: dhcpd, tags: ['dhcpd'] }
    - { role: dhparams, tags: ['dhparams'] }
    - { role: doas, tags: ['doas'] }
    - { role: facette, tags: ['facette'] }
    - { role: flashrom, tags: ['flashrom'] }
    - { role: geoip, tags: ['geoip'] }
  # - { role: gixy, tags: ['flashrom'] }
  # - { role: goaccess, tags: ['goaccess'] }
  # - { role: httpd, tags: ['httpd'] }
    - { role: iftop, tags: ['iftop'] }
    - { role: iked, tags: ['iked'] }
    - { role: letsencrypt, tags: ['letsencrypt'] }
    - { role: locale, tags: ['locale'] }
    - { role: monit, tags: ['monit'] }
  # - newsyslog
    - { role: nginx, tags: ['nginx'] }
    - { role: nsd, tags: ['nsd'] }
    - { role: ntpd, tags: ['ntpd'] }
    - { role: openvpn, tags: ['openvpn'] }
    - { role: periodic, tags: ['periodic'] }
    - { role: pf, tags: ['pf'] }
    - { role: pftop, tags: ['pftop'] }
    - { role: python, tags: ['python'] }
    - { role: router, tags: ['router'] }
    - { role: rtadvd, tags: ['rtadvd'] }
    - { role: smtpd, tags: ['smtpd'] }
    - { role: sndiod, tags: ['sndiod'] }
    - { role: squid, tags: ['squid'] }
    - { role: ssh, tags: ['ssh'] }
    - { role: sysclean, tags: ['sysclean'] }
    - { role: sysmerge, tags: ['sysmerge'] }
    - { role: unbound, tags: ['unbound'] }

  tasks:
    - name: boot configuration
      copy:
        src=boot.conf dest=/etc/boot.conf
        owner=root group=wheel mode=0444

  # - name: 'terminal initialization information'
  #   replace:
  #     dest=/etc/ttys
  #     regexp='^(console\s+.+)\s+secure$'
  #     replace='\1'

    - name: sysctl variables to set at system startup
      sysctl:
        name={{ item.key }} value={{ item.value }}
        reload=no sysctl_set=yes
      with_dict:
        ddb.panic: 0
      # net.inet.divert.recvspace: 131072
      # net.inet.ip.ifq.maxlen: 512
      # net.inet.tcp.mssdflt: 1460
        net.inet.udp.recvspace: 131072
        net.inet.udp.sendspace: 131072
      # net.inet6.divert.recvspace: 131072
      # net.inet6.ip6.ifq.maxlen: 512

  handlers:
  - name: netstart
    command: /bin/sh /etc/netstart
...
