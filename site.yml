# site
---
- hosts: tombstone

  pre_tasks:

    - name: set localtime link
      file:
        src: /usr/share/zoneinfo/{{ timezone }}
        dest: /etc/localtime
        state: link
        force: true

    - name: default hostname
      copy:
        content: "tombstone.{{ global_domain }}\n"
        dest: /etc/myname
        owner: root
        group: wheel
        mode: 0444

    - name: host name database
      template:
        src: hosts.j2
        dest: /etc/hosts
        owner: root
        group: wheel
        mode: 0444

    - name: resolver configuration file
      template:
        src: templates/resolv.conf.j2
        dest: /etc/resolv.conf
        owner: root
        group: wheel
        mode: 0444

    - name: sysctl variables to set at system startup
      sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        reload: true
        sysctl_set: true
      with_dict:
        ddb.panic: 0
        net.inet.ip.forwarding: 1
        net.inet6.ip6.forwarding: 1

    - name: interface-specific configuration files
      template:
        src: hostname.{{ item }}.j2
        dest: /etc/hostname.{{ item }}
        owner: root
        group: wheel
        mode: 0440
      with_items:
        - "{{ guest_if }}"
        - "{{ lan_if }}"
        - "{{ pppoe_if }}"
        - "{{ wan_if }}"
        - "{{ wlan_if }}"
      notify: netstart

    - name: system-wide package system configuration
      copy:
        content: "{{ installurl }}\n"
        dest: /etc/installurl
        owner: root
        group: wheel
        mode: 0444

    - meta: flush_handlers

  roles:

    - {role: apmd, tags: [apmd]}
    - {role: avahi, tags: [avahi]}
    - {role: collectd, tags: [collectd]}
    - {role: dhcpcd, tags: [dhcpcd]}
    - {role: dhcpd, tags: [dhcpd]}
    - {role: doas, tags: [doas]}
    - {role: facette, tags: [facette]}
    - {role: flashrom, tags: [flashrom]}
    # - {role: iked, tags: [iked]}
    # - {role: iplayer, tags: [iplayer]}
    # - {role: locale, tags: [locale]}
    # - {role: monit, tags: [monit]}
    - {role: nginx, tags: [nginx]}
    - {role: ntpd, tags: [ntpd]}
    - {role: openvpn, tags: [openvpn]}
    # - {role: periodic, tags: [periodic]}
    - {role: pf, tags: [pf]}
    # - {role: pftop, tags: [pftop]}
    - {role: python, tags: [python]}
    - {role: rtadvd, tags: [rtadvd]}
    - {role: slaacd, tags: [slaacd]}
    - {role: smtpd, tags: [smtpd]}
    - {role: sndiod, tags: [sndiod]}
    - {role: ssh, tags: [ssh]}
    - {role: sysclean, tags: [sysclean]}
    - {role: sysmerge, tags: [sysmerge]}
    - {role: tor, tags: [tor]}
    - {role: unbound, tags: [unbound]}

  tasks:

    - name: boot configuration
      copy:
        src: boot.conf
        dest: /etc/boot.conf
        owner: root
        group: wheel
        mode: 0444

    # - name: terminal initialization information
    #   replace:
    #     dest: /etc/ttys
    #     regexp: '^(console\s+.+)\s+secure$'
    #     replace: '\1'

    - name: update root user GECOS
      user:
        name: root
        comment: ''
        createhome: false
        state: present

  handlers:

    - name: netstart
      command: /bin/sh /etc/netstart
...
