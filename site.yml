# yamllint disable rule:line-length
---
- hosts: all
  gather_facts: false

  pre_tasks:

    - name: create custom fact directory
      file:
        path: /etc/ansible/facts.d
        state: directory
        owner: root
        mode: 0755
      when: false

    - name: install custom fact file
      template:
        src: facts.d/custom.fact.j2
        dest: /etc/ansible/facts.d/custom.fact
        owner: root
        mode: 0555
        validate: /bin/sh -n %s
      when: false

- hosts: diskstation

  pre_tasks:

    - name: set timezone
      lineinfile:
        path: /etc/synoinfo.conf
        regexp: "^timezone="
        line: timezone=Singapore
        owner: root
        group: root
        mode: 0644
      when: false

    - name: set localtime
      copy:
        content: "<+08>-8\n"
        dest: /etc/TZ
        owner: root
        group: root
        mode: 0644
      when: false

  roles:

    - role: cloud-sync
    - role: datadog-agent
    - role: homebridge
    - role: imapfilter
    - role: pihole
    - role: unbound
    - role: video-station

- hosts: unifi

  roles:

    - role: unifi

- hosts: usg

  pre_tasks:

    - name: Package update repository parameters
      edgeos_config:
        lines:
          - set system package repository {{ ansible_distribution_release }} components main
          - set system package repository {{ ansible_distribution_release }} distribution {{ ansible_distribution_release }}
          - set system package repository {{ ansible_distribution_release }} url http://archive.debian.org/debian
        save: true
      connection: network_cli
      register: r
      notify: update apt cache
      when: inventory_hostname == 'usg'

  tasks:

    - lineinfile:
        path: /etc/avahi/avahi-daemon.conf
        regexp: allow-interfaces=
        line: allow-interfaces={{ lan_if }}
      notify: restart avahi-daemon
      when: inventory_hostname == 'usg'

    - lineinfile:
        path: /etc/avahi/avahi-daemon.conf
        regexp: deny-interfaces=
        line: deny-interfaces={{ wan_if }}
      notify: restart avahi-daemon
      when: inventory_hostname == 'usg'

    - name: install ddclient dependencies
      apt:
        name: libdata-validate-ip-perl
        install_recommends: false
        state: present
      when: inventory_hostname == 'usg'

    - name: upgrade ddclient
      get_url:
        url: https://raw.githubusercontent.com/ddclient/ddclient/v3.9.0/ddclient
        dest: /usr/sbin/ddclient
        backup: true
        owner: root
        group: root
        mode: 0555
        checksum: sha1:fc443f87fbe35f923a069d120cd3170398f151f7
      when: inventory_hostname == 'usg'

    - name: Domain Name Server (DNS) parameters
      edgeos_config:
        lines:
          - set service dns dynamic interface {{ hostvars['usg']['wan_if'] }} service cloudflare host-name {{ dynamic_dns_cloudflare_host_name }}
          - set service dns dynamic interface {{ hostvars['usg']['wan_if'] }} service cloudflare login {{ dynamic_dns_cloudflare_login }}
          - set service dns dynamic interface {{ hostvars['usg']['wan_if'] }} service cloudflare options {{ dynamic_dns_cloudflare_options }}
          - set service dns dynamic interface {{ hostvars['usg']['wan_if'] }} service cloudflare password '{{ dynamic_dns_cloudflare_password }}'
          - set service dns dynamic interface {{ hostvars['usg']['wan_if'] }} service cloudflare server {{ dynamic_dns_cloudflare_server }}
          # - set service dns dynamic interface {{ hostvars['usg']['wan_if'] }} service custom-dnsomatic host-name {{ dynamic_dns_dnsomatic_host_name }}
          # - set service dns dynamic interface {{ hostvars['usg']['wan_if'] }} service custom-dnsomatic login {{ dynamic_dns_dnsomatic_login }}
          # - set service dns dynamic interface {{ hostvars['usg']['wan_if'] }} service custom-dnsomatic password '{{ dynamic_dns_dnsomatic_password }}'
          # - set service dns dynamic interface {{ hostvars['usg']['wan_if'] }} service custom-dnsomatic protocol {{ dynamic_dns_dnsomatic_protocol }}
          # - set service dns dynamic interface {{ hostvars['usg']['wan_if'] }} service custom-dnsomatic server {{ dynamic_dns_dnsomatic_server }}
          # - set service dns forwarding cache-size 10000
          # - set service dns forwarding except-interface {{ wan_if }}
          # - set service dns forwarding options domain-needed
          # - set service dns forwarding options no-resolv  # FIXME: is this needed?
          # - set service dns forwarding options proxy-dnssec
        save: true
      connection: network_cli
      when: inventory_hostname == 'usg'

  handlers:

    - name: restart avahi-daemon
      service:
        name: avahi-daemon
        state: restarted

    - name: update apt cache
      apt:
        update_cache: true
