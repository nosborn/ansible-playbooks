# yamllint disable rule:line-length
---
- hosts: all

  pre_tasks:
    - name: gather facts from excluded hosts
      ansible.builtin.setup:
      delegate_to: "{{ item }}"
      delegate_facts: true
      loop: "{{ groups['all'] }}"
      when: item not in ansible_play_hosts
      run_once: true
      tags:
        - always

- hosts: tombstone
  gather_facts: false

  pre_tasks:
    - name: install ACL support
      ansible.builtin.apt:
        name: acl
        install_recommends: false

    - name: set time zone
      ansible.builtin.file:
        path: /etc/localtime
        src: /usr/share/zoneinfo/{{ timezone }}
        state: link
      tags:
        - always

    - name: set time zone
      ansible.builtin.copy:
        content: "{{ timezone }}\n"
        dest: /etc/timezone
        owner: root
        group: root
        mode: 0444
      tags:
        - always

    - name: configure hosts file
      ansible.builtin.lineinfile:
        path: /etc/hosts
        regexp: "^127\\.0\\.1\\.1\t"
        line: "{{ lan_ipv4_address }}\ttombstone.{{ domain_name }}\ttombstone"
      tags:
        - always

    - name: configure network interfaces
      ansible.builtin.template:
        src: network/interfaces.j2
        dest: /etc/network/interfaces
        owner: root
        group: root
        mode: 0444
      notify: restart networking
      tags:
        - always

    - name: restart networking now
      ansible.builtin.meta: flush_handlers

  roles:
    - role: chrony
    - role: grafana
      tags:
        - grafana
    - role: grub
      tags:
        - grub
    - role: homebridge
      tags:
        - homebridge
    - role: imapfilter
      tags:
        - imapfilter
    - role: k3s
      tags:
        - k3s
    - role: locale
    - role: loki
      tags:
        - loki
      when: false
    - role: prometheus
      tags:
        - prometheus
      when: false
    - role: promtail
      tags:
        - promtail
      when: false
    - role: rfkill
    - role: rsyslog
      tags:
        - rsyslog
    - role: sshd
    - role: tcpdump
    - role: teleport
      tags:
        - teleport
      when: false
    - role: unbound
      tags:
        - unbound

  handlers:
    - name: restart networking
      ansible.builtin.systemd:
        name: networking.service
        state: restarted

- hosts: cloudkey
  gather_facts: false

  roles:
    - role: unifi

- hosts: gateway
  gather_facts: false

  roles:
    - role: unifi_gateway
