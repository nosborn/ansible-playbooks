# yamllint disable rule:line-length
---
- hosts: diskstation

  pre_tasks:
    - name: set timezone
      lineinfile:
        path: /etc/synoinfo.conf
        regexp: ^timezone=
        line: timezone={{ synology_timezone }}
        owner: root
        group: root
        mode: 0644
      when: false

    - name: set localtime
      copy:
        content: "{{ synology_tz }}\n"
        dest: /etc/TZ
        owner: root
        group: root
        mode: 0644
      when: false

  roles:
    # - role: cloud-sync
    - role: download-station
    - role: get_iplayer
    - role: homebridge
    - role: imapfilter
    - role: itunes-server
    - role: unbound
    - role: video-station

- hosts: unifi

  roles:
    - role: unifi

- hosts: usg

  tasks:
    - name: install script to mangle TTL with iptables
      template:
        src: post-config.d/iptables_ttl_mangle.sh.j2
        dest: /config/scripts/post-config.d/iptables_ttl_mangle.sh
        owner: root
        group: vyattacfg
        mode: 0755
        validate: /bin/sh -n %s
      notify: iptables mangle ttl

    - name: set allowed interfaces for avahi
      lineinfile:
        path: /etc/avahi/avahi-daemon.conf
        regexp: allow-interfaces=
        line: allow-interfaces={{ lan_if }},{{ iot_if }}
      notify: restart avahi-daemon

    - name: set denied interfaces for avahi
      lineinfile:
        path: /etc/avahi/avahi-daemon.conf
        regexp: deny-interfaces=
        line: deny-interfaces={{ wan_if }}
      notify: restart avahi-daemon

  handlers:
    - name: iptables mangle ttl
      command: /config/scripts/post-config.d/iptables_ttl_mangle.sh

    - name: restart avahi-daemon
      service:
        name: avahi-daemon
        state: restarted
