# site
---
- hosts: tombstone

  pre_tasks:

    - name: set localtime link
      file:
        src: /usr/share/zoneinfo/{{ timezone }}
        dest: /etc/localtime
        state: link
        force: true

    - name: default hostname
      copy:
        content: "{{ ansible_hostname }}.{{ global_domain }}\n"
        dest: /etc/myname
        owner: root
        group: wheel
        mode: 0444

    - name: host name database
      template:
        src: hosts.j2
        dest: /etc/hosts
        owner: root
        group: wheel
        mode: 0444

    - name: sysctl variables to set at system startup
      sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        reload: true
        sysctl_set: true
      with_dict: "{{ sysctl }}"

    - name: resolver configuration file
      template:
        src: templates/resolv.conf.tail.j2
        dest: /etc/resolv.conf.tail
        owner: root
        group: wheel
        mode: 0444
      notify: restart networking

    - name: interface-specific configuration files
      template:
        src: hostname.{{ item }}.j2
        dest: /etc/hostname.{{ item }}
        owner: root
        group: wheel
        mode: 0440
      with_items: "{{ interfaces|sort }}"
      notify: restart networking

    - name: system-wide package system configuration
      copy:
        content: "{{ installurl }}\n"
        dest: /etc/installurl
        owner: root
        group: wheel
        mode: 0444
      when: false

    - meta: flush_handlers

  roles:

    - role: apmd
    - role: avahi
    - role: collectd
    - role: ddclient
    - role: dhcpcd
    - role: dhcpd
    - role: doas
    - role: facette
    - role: flashrom
    - role: monit
    - role: ntpd
    - role: periodic
      when: false
    - role: pf
    - role: rad
    - role: slaacd
    - role: smtpd
    # - role: snap
    #   when: ansible_os_release == 'current'
    - role: sndiod
    - role: sshd
    - role: sysclean
    - role: sysmerge
    - role: unbound

  tasks:

    - name: boot configuration
      copy:
        src: boot.conf
        dest: /etc/boot.conf
        owner: root
        group: wheel
        mode: 0444

    # - name: terminal initialization information
    #   replace:
    #     dest: /etc/ttys
    #     regexp: '^(console\s+.+)\s+secure$'
    #     replace: '\1'

  handlers:

    - name: restart networking
      command: sh /etc/netstart
...
