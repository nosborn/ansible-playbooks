# yamllint disable rule:line-length
---
- name: Gather facts
  hosts: all

  pre_tasks:
    - name: gather facts from excluded hosts
      ansible.builtin.setup:
      delegate_to: "{{ item }}"
      delegate_facts: true
      loop: "{{ groups['all'] }}"
      when: item not in ansible_play_hosts
      run_once: true
      tags:
        - always

- name: Configure Tombstone
  hosts: tombstone
  gather_facts: false

  pre_tasks:
    - name: set time zone
      ansible.builtin.file:
        path: /etc/localtime
        src: /usr/share/zoneinfo/{{ timezone }}
        state: link
      tags:
        - always

    # - name: configure hosts file
    #   ansible.builtin.lineinfile:
    #     path: /etc/hosts
    #     regexp: "^127\\.0\\.1\\.1\t"
    #     line: "{{ lan_ipv4_address }}\ttombstone.{{ domain_name }}\ttombstone"
    #   tags:
    #     - always

    - name: configure LAN interface
      ansible.builtin.copy:
        content: |
          inet {{ lan_ipv4_address }} 0xffffff00
          inet6 autoconf
        dest: /etc/hostname.{{ lan_if }}
        owner: root
        group: wheel
        mode: !!str 0440
      notify: netstart lan_if
      tags:
        - always
      when: false

    - name: restart networking now
      ansible.builtin.meta: flush_handlers

    - name: enable forwarding
      ansible.posix.sysctl:
        name: "{{ item }}"
        value: 1
        sysctl_set: true
      loop:
        - net.inet.ip.forwarding
        - net.inet6.ip6.forwarding
      tags:
        - always

    - name: configure kernel
      ansible.builtin.copy:
        content: "{{ kernel_configuration }}"
        dest: /etc/bsd.re-config
        owner: root
        group: wheel
        mode: !!str 0444
      tags:
        - always

  roles:
    - role: apmd
    - role: blocky
      tags:
        - blocky
    - role: grafana
    - role: homebridge
    - role: imapfilter
    - role: loki
    # - role: ntpd
    - role: prometheus
    # - role: rsyslog
    - role: sndiod
    # - role: sshd
    - role: unbound
      tags:
        - unbound
    # - role: wireguard

  handlers:
    - name: netstart lan_if
      ansible.builtin.command:
        argv:
          - /etc/netstart
          - "{{ lan_if }}"

    - name: netstart wireguard_if
      ansible.builtin.command:
        argv:
          - /etc/netstart
          - "{{ wireguard_if }}"

- name: Configure CloudKey
  hosts: cloudkey
  gather_facts: false

  roles:
    - role: unifi

- name: Configure Gateway
  hosts: gateway
  gather_facts: false

  roles:
    - role: unifi_gateway
