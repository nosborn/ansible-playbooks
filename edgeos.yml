# edgeos (WAS: site)
# yamllint disable rule:line-length
---
- hosts: EdgeOS

  pre_tasks:
    - name: System domain name
      edgeos_config:
        lines:
          - set system domain-name {{ global_domain }}
        save: true
      connection: network_cli

    - name: System host name
      edgeos_config:
        lines:
          - set system host-name {{ inventory_hostname }}
        save: true
      connection: network_cli

    - name: Domain Name Server (DNS)
      edgeos_config:
        lines:
          - set system name-server 1.1.1.1
          - set system name-server 1.0.0.1
          - set system name-server 2606:4700:4700::1111
          - set system name-server 2606:4700:4700::1001
        save: true
      connection: network_cli

    - name: Local time zone
      edgeos_config:
        lines:
          - set system time-zone {{ timezone }}
        save: true
      connection: network_cli

    - meta: flush_handlers

  tasks:
    - name: Firewall
      edgeos_config:
        lines:
          - set firewall all-ping enable
          - set firewall broadcast-ping disable
          - set firewall ipv6-name LANv6_IN default-action accept
          # - set firewall ipv6-name LANv6_IN description 'WAN inbound traffic forwarded to LAN'
          - set firewall ipv6-name LANv6_IN rule 10 action reject
          - set firewall ipv6-name LANv6_IN rule 10 description 'Block plain SMTP'
          - set firewall ipv6-name LANv6_IN rule 10 destination port 25
          - set firewall ipv6-name LANv6_IN rule 10 log enable
          - set firewall ipv6-name LANv6_IN rule 10 protocol tcp
          - set firewall ipv6-name LANv6_IN rule 20 action reject
          - set firewall ipv6-name LANv6_IN rule 20 description 'Captive DNS for LAN'
          - set firewall ipv6-name LANv6_IN rule 20 destination port 53
          - set firewall ipv6-name LANv6_IN rule 20 log enable
          - set firewall ipv6-name LANv6_IN rule 20 protocol tcp_udp
          - set firewall ipv6-name LANv6_IN rule 30 action reject
          - set firewall ipv6-name LANv6_IN rule 30 description 'Captive DNS for LAN'
          - set firewall ipv6-name LANv6_IN rule 30 destination port 853
          - set firewall ipv6-name LANv6_IN rule 30 disable # TODO
          - set firewall ipv6-name LANv6_IN rule 30 log enable
          - set firewall ipv6-name LANv6_IN rule 30 protocol tcp_udp
          - set firewall ipv6-name WANv6_IN default-action drop
          - set firewall ipv6-name WANv6_IN description 'WAN inbound traffic forwarded to LAN'
          - set firewall ipv6-name WANv6_IN enable-default-log
          - set firewall ipv6-name WANv6_IN rule 10 action accept
          - set firewall ipv6-name WANv6_IN rule 10 description 'Allow established/related sessions'
          - set firewall ipv6-name WANv6_IN rule 10 state established enable
          - set firewall ipv6-name WANv6_IN rule 10 state related enable
          - set firewall ipv6-name WANv6_IN rule 20 action drop
          - set firewall ipv6-name WANv6_IN rule 20 description 'Drop invalid state'
          - set firewall ipv6-name WANv6_IN rule 20 log enable
          - set firewall ipv6-name WANv6_IN rule 20 state invalid enable
          - set firewall ipv6-name WANv6_IN rule 30 action accept
          - set firewall ipv6-name WANv6_IN rule 30 description 'Allow IPv6 ICMP'
          - set firewall ipv6-name WANv6_IN rule 30 protocol ipv6-icmp
          - set firewall ipv6-name WANv6_LOCAL default-action drop
          - set firewall ipv6-name WANv6_LOCAL description 'WAN inbound traffic to the router'
          - set firewall ipv6-name WANv6_LOCAL enable-default-log
          - set firewall ipv6-name WANv6_LOCAL rule 10 action accept
          - set firewall ipv6-name WANv6_LOCAL rule 10 description 'Allow established/related sessions'
          - set firewall ipv6-name WANv6_LOCAL rule 10 state established enable
          - set firewall ipv6-name WANv6_LOCAL rule 10 state related enable
          - set firewall ipv6-name WANv6_LOCAL rule 20 action drop
          - set firewall ipv6-name WANv6_LOCAL rule 20 description 'Drop invalid state'
          - set firewall ipv6-name WANv6_LOCAL rule 20 log enable
          - set firewall ipv6-name WANv6_LOCAL rule 20 state invalid enable
          - set firewall ipv6-name WANv6_LOCAL rule 30 action accept
          - set firewall ipv6-name WANv6_LOCAL rule 30 description 'Allow IPv6 ICMP'
          - set firewall ipv6-name WANv6_LOCAL rule 30 protocol ipv6-icmp
          - set firewall ipv6-name WANv6_LOCAL rule 40 action accept
          - set firewall ipv6-name WANv6_LOCAL rule 40 description 'Allow DHCPv6'
          - set firewall ipv6-name WANv6_LOCAL rule 40 destination port 546
          - set firewall ipv6-name WANv6_LOCAL rule 40 protocol udp
          - set firewall ipv6-name WANv6_LOCAL rule 40 source port 547
          - set firewall ipv6-name WANv6_LOCAL rule 50 action drop
          - set firewall ipv6-name WANv6_LOCAL rule 50 description 'Drop UBNT Device Discovery'
          - set firewall ipv6-name WANv6_LOCAL rule 50 destination port 10001
          - set firewall ipv6-name WANv6_LOCAL rule 50 log enable
          - set firewall ipv6-name WANv6_LOCAL rule 50 protocol tcp_udp
          - set firewall ipv6-receive-redirects disable
          - set firewall ipv6-src-route disable
          - set firewall ip-src-route disable
          - set firewall log-martians enable
          - set firewall modify PBR_policy rule 20 modify table 1
          - set firewall modify PBR_policy rule 20 source address {{ guest_ipv4_subnet }}
          - set firewall name LAN_IN default-action accept
          # - set firewall name LAN_IN description 'WAN to internal'
          - set firewall name LAN_IN rule 10 action reject
          - set firewall name LAN_IN rule 10 description 'Block plain SMTP'
          - set firewall name LAN_IN rule 10 destination port 25
          - set firewall name LAN_IN rule 10 log enable
          - set firewall name LAN_IN rule 10 protocol tcp
          - set firewall name LAN_IN rule 20 action reject
          - set firewall name LAN_IN rule 20 description 'Captive DNS for LAN'
          - set firewall name LAN_IN rule 20 destination port 853
          - set firewall name LAN_IN rule 20 disable # TODO
          - set firewall name LAN_IN rule 20 log enable
          - set firewall name LAN_IN rule 20 protocol tcp_udp
          - set firewall name WAN_IN default-action drop
          - set firewall name WAN_IN description 'WAN to internal'
          - set firewall name WAN_IN enable-default-log
          - set firewall name WAN_IN rule 10 action accept
          - set firewall name WAN_IN rule 10 description 'Allow established/related'
          - set firewall name WAN_IN rule 10 state established enable
          - set firewall name WAN_IN rule 10 state related enable
          - set firewall name WAN_IN rule 20 action drop
          - set firewall name WAN_IN rule 20 description 'Drop invalid state'
          - set firewall name WAN_IN rule 20 log enable
          - set firewall name WAN_IN rule 20 state invalid enable
          - set firewall name WAN_LOCAL default-action drop
          - set firewall name WAN_LOCAL description 'WAN to router'
          - set firewall name WAN_LOCAL enable-default-log
          - set firewall name WAN_LOCAL rule 10 action accept
          - set firewall name WAN_LOCAL rule 10 description 'Allow established/related'
          - set firewall name WAN_LOCAL rule 10 state established enable
          - set firewall name WAN_LOCAL rule 10 state related enable
          - set firewall name WAN_LOCAL rule 20 action drop
          - set firewall name WAN_LOCAL rule 20 description 'Drop invalid state'
          - set firewall name WAN_LOCAL rule 20 log enable
          - set firewall name WAN_LOCAL rule 20 state invalid enable
          - set firewall name WAN_LOCAL rule 30 action accept
          - set firewall name WAN_LOCAL rule 30 description 'Allow PING'
          - set firewall name WAN_LOCAL rule 30 icmp type-name echo-request
          - set firewall name WAN_LOCAL rule 30 protocol icmp
          - set firewall name WAN_LOCAL rule 40 action accept
          - set firewall name WAN_LOCAL rule 40 description 'Allow L2TP'
          - set firewall name WAN_LOCAL rule 40 destination port 1701
          - set firewall name WAN_LOCAL rule 40 ipsec match-ipsec
          - set firewall name WAN_LOCAL rule 40 protocol udp
          - set firewall name WAN_LOCAL rule 50 action accept
          - set firewall name WAN_LOCAL rule 50 description 'Allow IKE and NAT-T'
          - set firewall name WAN_LOCAL rule 50 destination port 500,4500
          - set firewall name WAN_LOCAL rule 50 protocol udp
          - set firewall name WAN_LOCAL rule 60 action accept
          - set firewall name WAN_LOCAL rule 60 description 'Allow ESP'
          - set firewall name WAN_LOCAL rule 60 protocol esp
          - set firewall name WAN_LOCAL rule 70 action drop
          - set firewall name WAN_LOCAL rule 70 description 'Drop UBNT Device Discovery'
          - set firewall name WAN_LOCAL rule 70 destination port 10001
          - set firewall name WAN_LOCAL rule 70 log enable
          - set firewall name WAN_LOCAL rule 70 protocol tcp_udp
          - set firewall receive-redirects disable
          - set firewall send-redirects enable
          - set firewall source-validation disable
          - set firewall syn-cookies enable
        save: true
      connection: network_cli

    - name: Network interfaces
      edgeos_config:
        lines:
          - set interfaces ethernet {{ wan_if }} address dhcp
          - set interfaces ethernet {{ wan_if }} description Internet
          - set interfaces ethernet {{ wan_if }} dhcp-options name-server no-update
          - set interfaces ethernet {{ wan_if }} dhcpv6-pd no-dns
          - set interfaces ethernet {{ wan_if }} dhcpv6-pd pd 0 interface {{ lan_if }} host-address ::1
          - delete interfaces ethernet {{ wan_if }} dhcpv6-pd pd 0 interface {{ lan_if }} no-dns
          - set interfaces ethernet {{ wan_if }} dhcpv6-pd pd 0 interface {{ lan_if }} service slaac
          - set interfaces ethernet {{ wan_if }} dhcpv6-pd pd 0 prefix-length /64
          - set interfaces ethernet {{ wan_if }} dhcpv6-pd rapid-commit enable
          - set interfaces ethernet {{ wan_if }} duplex auto
          - set interfaces ethernet {{ wan_if }} firewall in ipv6-name WANv6_IN
          - set interfaces ethernet {{ wan_if }} firewall in name WAN_IN
          - set interfaces ethernet {{ wan_if }} firewall local ipv6-name WANv6_LOCAL
          - set interfaces ethernet {{ wan_if }} firewall local name WAN_LOCAL
          - set interfaces ethernet {{ wan_if }} speed auto
          - set interfaces ethernet {{ lan_if }} address {{ lan_ipv4_address }}/24
          - set interfaces ethernet {{ lan_if }} description Local
          - set interfaces ethernet {{ lan_if }} duplex auto
          - set interfaces ethernet {{ lan_if }} firewall in ipv6-name LANv6_IN
          - set interfaces ethernet {{ lan_if }} firewall in name LAN_IN
          - set interfaces ethernet {{ lan_if }} ipv6 router-advert default-preference high
          # - set interfaces ethernet {{ lan_if }} ipv6 router-advert name-server {{ hostvars['dengo']['lan_ipv6_address'] }}
          - delete interfaces ethernet {{ lan_if }} ipv6 router-advert name-server
          - set interfaces ethernet {{ lan_if }} ipv6 router-advert prefix ::/64 autonomous-flag true
          - set interfaces ethernet {{ lan_if }} ipv6 router-advert prefix ::/64 on-link-flag true
          - set interfaces ethernet {{ lan_if }} ipv6 router-advert prefix ::/64 preferred-lifetime 604800
          - set interfaces ethernet {{ lan_if }} ipv6 router-advert prefix ::/64 valid-lifetime 2592000
          - set interfaces ethernet {{ lan_if }} ipv6 router-advert send-advert true
          - set interfaces ethernet {{ lan_if }} speed auto
          - set interfaces ethernet {{ lan_if }} vif {{ guest_vlan }} address {{ guest_ipv4_address }}/24
          - set interfaces ethernet {{ lan_if }} vif {{ guest_vlan }} description 'Guest Wi-Fi'
          - set interfaces ethernet {{ lan_if }} vif {{ guest_vlan }} firewall in modify PBR_policy
          - set interfaces ethernet {{ lan_if }} vif {{ guest_vlan }} ipv6 disable-forwarding
          - set interfaces ethernet {{ lan2_if }} address {{ lan2_ipv4_address }}/24
          - set interfaces ethernet {{ lan2_if }} description 'Local 2'
          - set interfaces ethernet {{ lan2_if }} duplex auto
          - set interfaces ethernet {{ lan2_if }} speed auto
        save: true
      connection: network_cli

    - name:
      edgeos_config:
        lines:
          - set protocols static table 1 interface-route 0.0.0.0/0 next-hop-interface {{ wan_if }}
        save: true
      connection: network_cli

    - name: Dynamic Host Configuration Protocol (DHCP) for DHCP server
      edgeos_config:
        lines:
          - set service dhcp-server disabled false
          - set service dhcp-server hostfile-update disable
          - set service dhcp-server shared-network-name GUEST authoritative enable
          - set service dhcp-server shared-network-name GUEST subnet {{ guest_ipv4_subnet }} default-router {{ guest_ipv4_address }}
          - set service dhcp-server shared-network-name GUEST subnet {{ guest_ipv4_subnet }} dns-server 208.67.222.222 # OpenDNS
          - set service dhcp-server shared-network-name GUEST subnet {{ guest_ipv4_subnet }} dns-server 208.67.220.220 # OpenDNS
          - set service dhcp-server shared-network-name GUEST subnet {{ guest_ipv4_subnet }} lease 86400
          - set service dhcp-server shared-network-name GUEST subnet {{ guest_ipv4_subnet }} ntp-server {{ guest_ipv4_address }}
          - set service dhcp-server shared-network-name GUEST subnet {{ guest_ipv4_subnet }} start {{ guest_ipv4_subnet|ipaddr('100')|ipaddr('address') }} stop {{ guest_ipv4_subnet|ipaddr('199')|ipaddr('address') }}
          - set service dhcp-server shared-network-name LAN1 authoritative enable
          - set service dhcp-server shared-network-name LAN1 subnet {{ lan_ipv4_subnet }} default-router {{ lan_ipv4_address }}
          - set service dhcp-server shared-network-name LAN1 subnet {{ lan_ipv4_subnet }} dns-server {{ hostvars['dengo']['lan_ipv4_address'] }}
          - set service dhcp-server shared-network-name LAN1 subnet {{ lan_ipv4_subnet }} domain-name {{ global_domain }}
          - set service dhcp-server shared-network-name LAN1 subnet {{ lan_ipv4_subnet }} lease 86400
          - set service dhcp-server shared-network-name LAN1 subnet {{ lan_ipv4_subnet }} ntp-server {{ lan_ipv4_address }}
          - set service dhcp-server shared-network-name LAN1 subnet {{ lan_ipv4_subnet }} start {{ lan_ipv4_subnet|ipaddr('100')|ipaddr('address') }} stop {{ lan_ipv4_subnet|ipaddr('199')|ipaddr('address') }}
          - set service dhcp-server shared-network-name LAN1 subnet {{ lan_ipv4_subnet }} static-mapping Dengo ip-address {{ hostvars['dengo']['lan_ipv4_address'] }}
          - set service dhcp-server shared-network-name LAN1 subnet {{ lan_ipv4_subnet }} static-mapping Dengo mac-address c0:3f:d5:6b:a6:66
          - set service dhcp-server shared-network-name LAN2 authoritative enable
          - set service dhcp-server shared-network-name LAN2 subnet {{ lan2_ipv4_subnet }} default-router {{ lan2_ipv4_address }}
          - set service dhcp-server shared-network-name LAN2 subnet {{ lan2_ipv4_subnet }} dns-server {{ lan2_ipv4_address }}
          - set service dhcp-server shared-network-name LAN2 subnet {{ lan2_ipv4_subnet }} domain-name {{ global_domain }}
          - set service dhcp-server shared-network-name LAN2 subnet {{ lan2_ipv4_subnet }} lease 86400
          - set service dhcp-server shared-network-name LAN2 subnet {{ lan2_ipv4_subnet }} ntp-server {{ lan2_ipv4_address }}
          - set service dhcp-server shared-network-name LAN2 subnet {{ lan2_ipv4_subnet }} start {{ lan2_ipv4_subnet|ipaddr('100')|ipaddr('address') }} stop {{ lan2_ipv4_subnet|ipaddr('199')|ipaddr('address') }}
          - delete service dhcp-server shared-network-name LAN2 subnet {{ lan2_ipv4_subnet }} static-mapping Dengo
          - delete service dhcp-server shared-network-name LAN2 subnet {{ lan2_ipv4_subnet }} static-mapping Tombstone
          - set service dhcp-server static-arp enable
          - set service dhcp-server use-dnsmasq disable
        save: true
      connection: network_cli

    - name: Domain Name Server (DNS) parameters
      edgeos_config:
        lines:
          - set service dns dynamic interface {{ wan_if }} service custom-dnsomatic host-name all.dnsomatic.com
          - set service dns dynamic interface {{ wan_if }} service custom-dnsomatic login {{ dynamic_dns_dnsomatic_login }}
          - set service dns dynamic interface {{ wan_if }} service custom-dnsomatic password '{{ dynamic_dns_dnsomatic_password }}'
          - set service dns dynamic interface {{ wan_if }} service custom-dnsomatic protocol dyndns2
          - set service dns dynamic interface {{ wan_if }} service custom-dnsomatic server updates.dnsomatic.com
          - set service dns dynamic interface {{ wan_if }} service custom-dynu host-name {{ dynamic_dns_dynu_host_name }}
          - set service dns dynamic interface {{ wan_if }} service custom-dynu login {{ dynamic_dns_dynu_login }}
          - set service dns dynamic interface {{ wan_if }} service custom-dynu password '{{ dynamic_dns_dynu_password }}'
          - set service dns dynamic interface {{ wan_if }} service custom-dynu protocol dyndns2
          - set service dns dynamic interface {{ wan_if }} service custom-dynu server api.dynu.com
          - set service dns forwarding cache-size {{ dns_forwarding_cache_size }}
          - set service dns forwarding listen-on {{ lan_if }}
          - set service dns forwarding listen-on {{ lan2_if }}
          - set service dns forwarding system
        save: true
      connection: network_cli

    - name: Web GUI settings
      edgeos_config:
        lines:
          - set service gui http-port 80
          - set service gui https-port 443
          - set service gui older-ciphers disable
        save: true
      connection: network_cli

    - name: Multicast DNS (mDNS) parameters
      edgeos_config:
        lines:
          - set service mdns reflector
          - delete service mdns repeater
        save: true
      connection: network_cli

    - lineinfile:
        path: /etc/avahi/avahi-daemon.conf
        regexp: allow-interfaces=
        line: allow-interfaces={{ lan_if }},{{ lan2_if }}
      notify: restart avahi-daemon

    - lineinfile:
        path: /etc/avahi/avahi-daemon.conf
        regexp: deny-interfaces=
        line: deny-interfaces={{ wan_if }}
      notify: restart avahi-daemon

    - name: Network Address Translation (NAT) parameters
      edgeos_config:
        lines:
          - set service nat rule 1000 description 'Captive DNS for LAN'
          - set service nat rule 1000 destination port 53
          - set service nat rule 1000 inbound-interface {{ lan_if }}
          - set service nat rule 1000 inside-address address {{ hostvars['dengo']['lan_ipv4_address'] }}
          - set service nat rule 1000 log enable
          - set service nat rule 1000 protocol tcp_udp
          - set service nat rule 1000 source address !{{ hostvars['dengo']['lan_ipv4_address'] }}
          - set service nat rule 1000 type destination
          - set service nat rule 5000 description 'Captive DNS for LAN'
          - set service nat rule 5000 destination address {{ hostvars['dengo']['lan_ipv4_address'] }}
          - set service nat rule 5000 destination port 53
          - set service nat rule 5000 log enable
          - set service nat rule 5000 outbound-interface {{ lan_if }}
          - set service nat rule 5000 protocol tcp_udp
          - set service nat rule 5000 type masquerade
          - set service nat rule 5010 description 'Masquerade for WAN'
          - set service nat rule 5010 outbound-interface {{ wan_if }}
          - set service nat rule 5010 type masquerade
        save: true
      connection: network_cli

    - name: Simple Network Management Protocol (SNMP)
      edgeos_config:
        lines:
          - delete service snmp
        save: true
      connection: network_cli

    - name: Secure SHell (SSH) protocol
      edgeos_config:
        lines:
          - delete service ssh allow-root
          - set service ssh disable-password-authentication
          - set service ssh protocol-version v2
        save: true
      connection: network_cli

    - name: Override default parameters of the Recovery Secure SHell (SSH) service
      edgeos_config:
        lines:
          - set service ssh-recovery disabled
        save: true
      connection: network_cli

    - name: UBNT discover settings
      edgeos_config:
        lines:
          - delete service ubnt-discover disable
          - set service ubnt-discover interface {{ guest_if }} disable
          - set service ubnt-discover interface {{ wan_if }} disable
        save: true
      connection: network_cli

    - name: UBNT discover server settings
      edgeos_config:
        lines:
          - delete service ubnt-discover-server disable
        save: true
      connection: network_cli

    - name: UNMS info
      edgeos_config:
        lines:
          - delete service unms
        save: true
      connection: network_cli

    - name: UPnP Internet Gateway Device (IGD)
      edgeos_config:
        lines:
          - delete service upnp
          - delete service upnp2
        save: true
      connection: network_cli

    - name: User login
      edgeos_config:
        lines:
          - set system login banner pre-login ''
        save: true
      connection: network_cli

    - name: Setting for hardware offload
      edgeos_config:
        lines:
          - set system offload ipsec disable # XXX: broken with L2TP?
          - set system offload ipv4 forwarding enable
          - set system offload ipv4 vlan enable
          - set system offload ipv6 forwarding enable
          # - set system offload ipv6 vlan enable
        save: true
      connection: network_cli

    - name: Package update repository parameters
      edgeos_config:
        lines:
          - set system package repository {{ ansible_distribution_release }} components 'main'
          - set system package repository {{ ansible_distribution_release }} distribution {{ ansible_distribution_release }}
          - set system package repository {{ ansible_distribution_release }} url 'http://ftp.sg.debian.org/debian'
        save: true
      connection: network_cli
      notify: apt-get update

    - name: System logging daemon
      edgeos_config:
        lines:
          # *.notice;auth,authpriv,cron,ftp,kern,lpr,mail,user.none        @loghost
          # auth,daemon,syslog,user.info;authpriv,kern.debug               @loghost
          # - set system syslog host 172.24.5.3 facility all level info
          - delete system syslog host
        save: true
      connection: network_cli

    - name: Settings for traffic analysis
      edgeos_config:
        lines:
          - set system traffic-analysis dpi enable
          - set system traffic-analysis export enable
          - delete system traffic-analysis signature-update
        save: true
      connection: network_cli

    - name: Virtual Private Network (VPN)
      edgeos_config:
        lines:
          - set vpn ipsec auto-firewall-nat-exclude disable
          - set vpn ipsec ipsec-interfaces interface {{ wan_if }}
          - set vpn l2tp remote-access authentication local-users username nick password '58WPZ46e3DhumYiiZ3mBRPX52MVW0bz'
          - set vpn l2tp remote-access authentication mode local
          - set vpn l2tp remote-access client-ip-pool start 192.168.4.100
          - set vpn l2tp remote-access client-ip-pool stop 192.168.4.199
          - set vpn l2tp remote-access dhcp-interface {{ wan_if }}
          - set vpn l2tp remote-access dns-servers server-1 {{ lan_ipv4_address }}
          - set vpn l2tp remote-access idle 1800
          - set vpn l2tp remote-access ipsec-settings authentication mode pre-shared-secret
          - set vpn l2tp remote-access ipsec-settings authentication pre-shared-secret '{{ vpn_l2tp_remote_access_pre_shared_secret }}'
          - set vpn l2tp remote-access ipsec-settings ike-lifetime 3600
          - set vpn l2tp remote-access ipsec-settings lifetime 3600
          - set vpn l2tp remote-access mtu 1492
        save: true
      connection: network_cli

    - name: Install AWS CLI
      apt:
        name: awscli
        install_recommends: false
        state: present

    - name: Install Route53 update script
      template:
        src: update-route53.sh.j2
        dest: /config/scripts/update-route53.sh
        owner: ubnt
        group: vyattacfg
        mode: 0550
        validate: /bin/sh -n %s

    - edgeos_config:
        lines:
          - set system task-scheduler task update-route53 executable path /config/scripts/update-route53.sh
          - set system task-scheduler task update-route53 interval 5m
        save: true
      connection: network_cli

    - name: Install node-exporter
      apt:
        name: prometheus-node-exporter
        install_recommends: false
        state: present

    - service:
        name: prometheus-node-exporter
        enabled: true
        state: started

  handlers:
    - name: apt-get update
      apt:
        update_cache: true

    - name: restart avahi-daemon
      service:
        name: avahi-daemon
        state: restarted
