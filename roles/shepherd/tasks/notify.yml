---
- name: prepare secret
  become: false
  delegate_to: localhost
  ansible.builtin.command:
    argv:
      - openssl
      - dgst
    stdin: NOTIFICATION_URLS={{ shepherd_notification_urls }}
  register: shepherd_notify_result
  changed_when: false

- name: create secret
  community.docker.docker_secret:
    name: shepherd-notify-{{ shepherd_notify_result.stdout | trim }}
    data: "NOTIFICATION_URLS={{ shepherd_notification_urls }}\n"
    labels:
      service: shepherd-notify

- name: deploy notifier
  community.docker.docker_swarm_service:
    name: shepherd-notify
    image: mazzolino/apprise-microservice:latest
    env:
      NOTIFICATION_URLS: "{{ shepherd_notification_urls }}" # FIXME
    hostname: shepherd-notify.{{ domain_name }}
    networks:
      - name: bridge
      - name: shepherd
    read_only: true
    secrets:
      - filename: /usr/src/app/app.env
        secret_name: shepherd-notify-{{ shepherd_notify_result.stdout | trim }}
    labels:
      traefik.enable: !!str false
    restart_config:
      condition: on-failure
      delay: 20s
