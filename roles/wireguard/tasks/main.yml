---
- name: install packages
  ansible.builtin.package:
    name: wireguard-tools
    state: present
  register: wireguard_result
  until: wireguard_result is not failed

- name: create directory
  ansible.builtin.file:
    path: /etc/wireguard
    owner: root
    group: root
    mode: !!str 0755
    state: directory

- name: configure
  ansible.builtin.template:
    src: interface.conf.j2
    dest: /etc/wireguard/{{ wireguard_if }}.conf
    owner: root
    group: root
    mode: !!str 0400
  notify: restart wireguard

- name: link service
  ansible.builtin.file:
    src: wg-quick
    dest: /etc/init.d/wg-quick.{{ wireguard_if }}
    state: link

- name: enable and start service
  ansible.builtin.service:
    name: wg-quick.{{ wireguard_if }}
    enabled: true
    state: started

- name: enable IP forwarding
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: !!str 1
    sysctl_set: true
    reload: true
#
# - name: configure clients
#   delegate_to: localhost
#   ansible.builtin.template:
#     src: client.conf.j2
#     dest: "{{ playbook_dir }}/wg-{{ wireguard_item.name }}.conf"
#     mode: !!str 0400
#   loop: "{{ vault_wireguard_peers }}"
#   loop_control:
#     loop_var: wireguard_item
