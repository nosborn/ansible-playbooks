---
- name: install wireguard
  ansible.builtin.apt:
    name: wireguard
    install_recommends: false

- name: create wireguard configuration directory
  ansible.builtin.file:
    path: /etc/wireguard
    owner: root
    group: root
    mode: 0700
    state: directory

# TODO: restart affected interfaces
- name: configure wireguard
  ansible.builtin.template:
    src: wireguard.conf.j2
    dest: /etc/wireguard/{{ wireguard_item.key }}.conf
    owner: root
    group: root
    mode: 0400
  loop: "{{ wireguard_configs | dict2items }}"
  loop_control:
    label: "{{ wireguard_item.key }}"
    loop_var: wireguard_item

- name: configure wireguard interfaces
  ansible.builtin.template:
    src: interface.j2
    dest: /etc/network/interfaces.d/{{ wireguard_item.key }}
    owner: root
    group: root
    mode: 0444
  notify:
    - ifdown {{ wireguard_item.key }}
    - ifup {{ wireguard_item.key }}
  loop: "{{ wireguard_interfaces | dict2items }}"
  loop_control:
    label: "{{ wireguard_item.key }}"
    loop_var: wireguard_item

- name: run any handler tasks
  ansible.builtin.meta: flush_handlers
