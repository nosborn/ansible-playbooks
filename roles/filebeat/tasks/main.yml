# roles/filebeat/tasks/main
# yamllint disable rule:line-length
---
- name: create persistent storage
  file:
    path: "{{ item }}"
    owner: root
    group: "1000"  # filebeat
    mode: 0770
    state: directory
  loop:
    - /volume1/docker/{{ filebeat_container_name }}/data

- name: install configuration files
  template:
    src: "{{ item }}.j2"
    dest: /volume1/docker/{{ filebeat_container_name }}/{{ item }}
    owner: root
    group: root
    mode: 0640
  loop:
    - filebeat.yml
  notify: restart filebeat

- name: create container
  docker_container:
    name: "{{ filebeat_container_name }}"
    comparisons:
      mac_address: ignore
    dns_servers:
      - "{{ hostvars['usg']['lan_ipv4_address'] }}"
    etc_hosts:
      elasticsearch: "{{ elasticsearch_ipv4_address }}"
      kibana: "{{ kibana_ipv4_address }}"
    env:
      TZ: "{{ timezone }}"
    exposed:
      - 9000/udp
    image: "{{ filebeat_image_name }}"
    init: true
    # mac_address: "02:42:c0:a8:01:c1"
    networks:
      - name: macvlan
        ipv4_address: "{{ filebeat_ipv4_address }}"
    networks_cli_compatible: true
    restart_policy: unless-stopped
    volumes:
      - /volume1/docker/{{ filebeat_container_name }}/data/:/usr/share/filebeat/data/:rw
      - /volume1/docker/{{ filebeat_container_name }}/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
