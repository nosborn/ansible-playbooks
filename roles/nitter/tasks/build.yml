---
- name: create source directory
  ansible.builtin.file:
    path: /usr/local/src/nitter
    owner: root
    group: root
    mode: 0755
    state: directory

- name: check out source
  ansible.builtin.git:
    repo: https://github.com/zedeus/nitter.git
    version: master
    dest: /usr/local/src/nitter

- name: derive source version
  ansible.builtin.command:
    argv:
      - git
      - log
      - --max-count=1
      - --pretty=format:%as-%h
    chdir: /usr/local/src/nitter
  register: nitter_version_result
  changed_when: false

- name: set image version fact
  ansible.builtin.set_fact:
    nitter_version: "{{ nitter_version_result.stdout | trim }}"

- name: build container image
  community.docker.docker_image:
    name: nitter:{{ nitter_version }}
    build:
      path: /usr/local/src/nitter
    source: build
