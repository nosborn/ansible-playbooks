# yamllint disable rule:line-length
---
- name: build Nitter
  ansible.builtin.import_tasks: build.yml

- name: create network
  community.docker.docker_network:
    name: nitter
    internal: true
    driver: overlay
    scope: swarm

- name: deploy redis
  ansible.builtin.import_tasks: redis.yml

- name: prepare configuration
  become: false
  delegate_to: localhost
  ansible.builtin.command:
    argv:
      - openssl
      - dgst
    stdin: "{{ lookup('ansible.builtin.template', 'nitter.conf.j2') }}"
  register: nitter_config_result
  changed_when: false

- name: create config
  community.docker.docker_config:
    name: nitter-{{ nitter_config_result.stdout | trim }}
    data: "{{ lookup('ansible.builtin.template', 'nitter.conf.j2') }}"
    labels:
      service: nitter

- name: deploy Nitter
  community.docker.docker_swarm_service:
    name: nitter
    image: nitter:{{ nitter_version }}
    configs:
      - config_name: nitter-{{ nitter_config_result.stdout | trim }}
        filename: /src/nitter.conf
    env:
      TZ: "{{ timezone }}"
    hostname: nitter.{{ domain_name }}
    networks:
      - name: bridge
      - name: nitter
      - name: traefik
    read_only: true
    labels:
      traefik.enable: !!str true
      traefik.http.middlewares.twitter-redirect.redirectregex.regex: ^https://twitter\.com/(.*)
      traefik.http.middlewares.twitter-redirect.redirectregex.replacement: https://nitter.{{ domain_name }}/${1}
      traefik.http.routers.nitter.entrypoints: websecure
      traefik.http.routers.nitter.rule: Host(`nitter.{{ domain_name }}`)
      traefik.http.routers.twitter.entrypoints: websecure
      traefik.http.routers.twitter.middlewares: twitter-redirect@docker
      traefik.http.routers.twitter.rule: Host(`twitter.com`)
      traefik.http.routers.twitter.service: nitter
      traefik.http.services.nitter.loadbalancer.server.port: !!str 8080
    container_labels:
      com.centurylinklabs.watchtower.enable: !!str false
    restart_config:
      condition: on-failure
      delay: 20s
    update_config:
      order: start-first

- name: issue certificate
  ansible.builtin.import_tasks: certificate.yml
