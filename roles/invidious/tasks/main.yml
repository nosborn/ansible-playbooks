---
- name: build invidious
  ansible.builtin.import_tasks: build.yml

- name: create network
  community.docker.docker_network:
    name: invidious
    driver: overlay
    internal: true
    scope: swarm

- name: deploy postgres
  ansible.builtin.import_tasks: postgres.yml

- name: deploy invidious
  community.docker.docker_swarm_service:
    name: invidious
    image: quay.io/invidious/invidious:latest
    env:
      INVIDIOUS_CONFIG: >
        {{ invidious_config | to_yaml }}
      TZ: "{{ timezone }}"
    hostname: invidious.{{ domain_name }}
    networks:
      - name: bridge
      - name: invidious
      - name: traefik
    read_only: true
    labels:
      traefik.enable: !!str true
      traefik.http.routers.invidious.entrypoints: websecure
      traefik.http.routers.invidious.rule: Host(`invidious.{{ domain_name }}`)
      traefik.http.services.invidious.loadbalancer.server.port: !!str 3000
    restart_config:
      condition: on-failure
      delay: 20s

- name: issue certificate
  ansible.builtin.import_tasks: certificate.yml
