# yamllint disable rule:line-length
---
- name: find version
  ansible.builtin.uri:
    url: https://update.k3s.io/v1-release/channels/stable
  register: k3s_result

- name: set version fact
  ansible.builtin.set_fact:
    k3s_version: "{{ k3s_result.url | regex_replace('.+/', '') }}"

- name: download binary
  ansible.builtin.get_url:
    url: https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/k3s
    checksum: sha256:https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/sha256sum-amd64.txt
    dest: /usr/local/bin/k3s
    owner: root
    group: root
    mode: 0755
  notify: restart k3s

- name: symlink additional commands
  ansible.builtin.file:
    src: k3s
    dest: /usr/local/bin/{{ item }}
    state: link
  loop:
    - crictl
    - kubectl

- name: configure service
  ansible.builtin.template:
    src: k3s.service.j2
    dest: /etc/systemd/system/k3s.service
    owner: root
    group: root
    mode: 0444
  notify: restart k3s

- name: enable and start service
  ansible.builtin.systemd:
    name: k3s.service
    daemon_reload: true
    enabled: true
    state: started

- name: wait for node-token
  ansible.builtin.wait_for:
    path: /var/lib/rancher/k3s/server/node-token
