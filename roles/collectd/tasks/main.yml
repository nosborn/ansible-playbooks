# roles/collectd/tasks/main
---
- name: OS-specific variables
  include_vars: "{{ ansible_distribution }}.yml"

- name: install packages
  apt:
    name: "{{ collectd_package_names }}"
    install_recommends: false
    state: present
  register: collectd_package_result
  until: collectd_package_result is succeeded
  when: ansible_os_family == 'Debian'

- name: install packages
  openbsd_pkg:
    name: "{{ collectd_package_names }}"
    state: present
  register: collectd_package_result
  until: collectd_package_result is succeeded
  when: ansible_os_family == 'OpenBSD'

- name: install configuration file
  template:
    src: collectd.conf.j2
    dest: "{{ collectd_confdir }}/collectd.conf"
    owner: root
    group: "{{ collectd_conffile_group }}"
    mode: "{{ collectd_conffile_mode }}"
  notify: restart collectd

- name: install plugins
  copy:
    src: unbound-stats.py
    dest: /usr/local/share/collectd/unbound-stats.py
    owner: root
    group: bin
    mode: 0444
    validate: python2 -mpy_compile %s
  notify: restart collectd
  when: ansible_os_family == 'OpenBSD'

- name: enable and start service
  service:
    name: collectd
    enabled: true
    state: started
...
