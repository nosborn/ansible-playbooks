# roles/homebridge/tasks/main
---
- name: create build directory
  file:
    path: /tmp/homebridge-image
    owner: root
    group: root
    mode: 0700
    state: directory

- name: upload Dockerfile
  template:
    src: Dockerfile.j2
    dest: /tmp/homebridge-image/Dockerfile
    owner: root
    group: root
    mode: 0400

- name: build image
  docker_image:
    name: "{{ homebridge_image_name }}"
    build:
      dockerfile: Dockerfile
      path: /tmp/homebridge-image
      pull: true
    source: build

- name: create persistent storage
  file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: 0755
    state: directory
  loop:
    - /volume1/docker/homebridge
    - /volume1/docker/homebridge/homebridge

- template:
    src: "{{ item }}.j2"
    dest: /volume1/docker/homebridge/homebridge/{{ item }}
    owner: root
    group: root
    mode: 0644
  loop:
    - config.json
  notify: restart homebridge

- name: create container
  docker_container:
    name: "{{ homebridge_container_name }}"
    # comparisons:
    #   mac_address: ignore
    dns_servers:
      - "{{ hostvars['usg']['lan_ipv4_address'] }}"
    image: "{{ homebridge_image_name }}"
    # mac_address: "fe:e1:ba:d0:ee:70"
    networks:
      - name: macvlan
        ipv4_address: "{{ homebridge_ipv4_address }}"
    networks_cli_compatible: true
    restart_policy: unless-stopped
    volumes:
      - /volume1/docker/homebridge/homebridge/:/homebridge/
