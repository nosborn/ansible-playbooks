---
- name: create homebridge user
  ansible.builtin.user:
    name: _homebridge
    comment: Homebridge
    create_home: false
    home: /var/homebridge
    login_class: daemon
    shell: /sbin/nologin
    uid: 999
    state: present

- name: create homebridge directory
  ansible.builtin.file:
    name: /var/homebridge
    owner: _homebridge
    group: _homebridge
    mode: 0700
    state: directory

- name: install homebridge package
  community.general.npm:
    name: homebridge
    version: "{{ homebridge_version }}"
    global: true
    unsafe_perm: true
    state: present
  notify: restart homebridge

- name: install homebridge plugins
  community.general.npm:
    name: "{{ item.key }}"
    version: "{{ item.value }}"
    global: true
    state: present
  loop: "{{ homebridge_plugins | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  notify: restart homebridge

- name: configure homebridge
  ansible.builtin.copy:
    content: "{{ homebridge_config | to_nice_json }}"
    dest: /var/homebridge/config.json
    owner: _homebridge
    group: _homebridge
    mode: 0440
  notify: restart homebridge

- name: install homebridge service
  ansible.builtin.copy:
    src: homebridge.rc
    dest: /etc/rc.d/homebridge
    owner: root
    group: wheel
    mode: 0555
    validate: ksh -n %s
  notify: restart homebridge

- name: enable and start homebridge
  ansible.builtin.service:
    name: homebridge
    enabled: true
    state: started
