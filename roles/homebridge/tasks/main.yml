---
- name: create user
  ansible.builtin.user:
    name: _homebridge
    comment: Homebridge
    create_home: false
    home: /var/homebridge
    shell: /sbin/nologin
    uid: 999
    state: present

- name: create directory
  ansible.builtin.file:
    name: /var/homebridge
    owner: _homebridge
    group: _homebridge
    mode: 0700
    state: directory

- name: install package
  community.general.npm:
    name: homebridge
    version: "{{ homebridge_version }}"
    global: true
    unsafe_perm: true
    state: present
  notify: restart homebridge

- name: install plugins
  community.general.npm:
    name: "{{ item.key }}"
    version: "{{ item.value.version }}"
    global: true
    state: present
  loop: "{{ homebridge_plugins | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  notify: restart homebridge

- name: upload config file
  ansible.builtin.template:
    src: config.json.j2
    dest: /var/homebridge/config.json
    owner: _homebridge
    group: _homebridge
    mode: 0640
    validate: "{{ jsonlint_validation_command }}"
  notify: restart homebridge

- name: install control script
  ansible.builtin.template:
    src: homebridge.rc.j2
    dest: /etc/rc.d/homebridge
    owner: root
    group: wheel
    mode: 0555
    validate: /bin/ksh -n %s
  notify: restart homebridge

- name: enable and start service
  ansible.builtin.service:
    name: homebridge
    enabled: true
    state: started
