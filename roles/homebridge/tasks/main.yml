# yamllint disable rule:line-length
---
- name: create build directory
  file:
    path: "{{ docker_persistent_storage }}/{{ homebridge_container_name }}"
    owner: root
    group: root
    mode: 0700
    state: directory

- name: upload build files
  template:
    src: "{{ item }}.j2"
    dest: "{{ docker_persistent_storage }}/{{ homebridge_container_name }}/{{ item }}"
    owner: root
    group: root
    mode: 0400
  loop:
    - .dockerignore
    - Dockerfile

- name: build image
  docker_image:
    name: "{{ homebridge_image_name }}"
    build:
      dockerfile: Dockerfile
      path: "{{ docker_persistent_storage }}/{{ homebridge_container_name }}"
      pull: true
    source: build

- name: create volume
  docker_volume:
    volume_name: "{{ homebridge_container_name }}"

- name: upload config file
  template:
    src: "{{ item }}.j2"
    dest: "{{ docker_persistent_storage }}/{{ homebridge_container_name }}/{{ item }}"
    owner: root
    group: root
    mode: 0640
  loop:
    - config.json
  notify: restart homebridge

- name: create container
  docker_container:
    name: "{{ homebridge_container_name }}"
    # cap_drop:
    #   - all
    # capabilities:
    #   - kill
    #   - net_bind_service
    #   - setgid
    #   - setuid
    comparisons:
      mac_address: ignore
    dns_servers:
      - "{{ unbound_ipv4_address }}"
    etc_hosts:
      unifi.osborn.io: "{{ hostvars['unifi']['lan_ipv4_address'] }}"
    image: "{{ homebridge_image_name }}"
    init: true
    networks:
      - name: macvlan
        ipv4_address: "{{ homebridge_ipv4_address }}"
    networks_cli_compatible: true
    restart_policy: unless-stopped
    volumes:
      - "{{ homebridge_container_name }}:/homebridge/"
      - "{{ docker_persistent_storage }}/{{ homebridge_container_name }}/config.json:/homebridge/config.json:ro"
