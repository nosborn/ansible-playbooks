# yamllint disable rule:line-length
---
- name: create traefik configuration directory
  ansible.builtin.file:
    path: "{{ traefik_config_dir }}"
    owner: root
    group: root
    mode: 0700
    state: directory

- name: configure traefik
  ansible.builtin.template:
    src: traefik.yml.j2
    dest: "{{ traefik_config_dir }}/traefik.yml"
    owner: root
    group: root
    mode: 0400
    validate: yamllint --strict %s
  notify: restart traefik

- name: configure traefik
  ansible.builtin.template:
    src: dynamic.yml.j2
    dest: "{{ traefik_config_dir }}/dynamic.yml"
    owner: root
    group: root
    mode: 0400
    validate: yamllint --strict %s

- name: create traefik-storage volume
  community.docker.docker_volume:
    name: traefik-storage

- name: deploy traefik
  community.docker.docker_container:
    name: traefik
    image: traefik:{{ traefik_version }}
    # cap_drop:
    #   - ALL
    # capabilities:
    env:
      LEGO_CA_CERTIFICATES: /etc/traefik/ca-certificates.crt
      LEGO_CA_SYSTEM_CERT_POOL: !!str true
      TZ: "{{ timezone }}"
    groups:
      - "{{ getent_group.docker[1] }}"
    # healthcheck:
    #   test: traefik healthcheck
    links:
      - step-ca:ca.{{ domain_name }}
    published_ports:
      - "{{ lan_ipv4_address }}:80:80"
      - "{{ lan_ipv4_address }}:443:443"
      - "{{ lan_ipv4_address }}:4141:4141"
      - "{{ lan_ipv4_address }}:8080:8080"
    read_only: true
    security_opts:
      - no-new-privileges=true
    volumes:
      - "{{ step_ca_config_dir }}/certs/root_ca.crt:/etc/traefik/ca-certificates.crt:ro"
      - "{{ traefik_config_dir }}/dynamic.yml:/etc/traefik/dynamic.yml:ro"
      - "{{ traefik_config_dir }}/traefik.yml:/etc/traefik/traefik.yml:ro"
      - /var/run/docker.sock:/var/run/docker.sock
      - traefik-storage:/storage
    labels:
      com.centurylinklabs.watchtower.enable: !!str true
    comparisons:
      labels: allow_more_present
      "*": strict
    restart_policy: unless-stopped
    state: started
