# yamllint disable rule:line-length
---
- name: create namespace
  kubernetes.core.k8s:
    resource_definition: |
      apiVersion: v1
      kind: Namespace
      metadata:
        annotations: {}
        labels:
          pod-security.kubernetes.io/enforce: restricted
        name: traefik

- name: create TLS secret
  kubernetes.core.k8s:
    namespace: traefik
    resource_definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: wildcard-tls
      type: kubernetes.io/tls
      stringData:
        tls.crt: "{{ hostvars['localhost']['ownca_wildcard_certificate'] }}"
        tls.key: "{{ hostvars['localhost']['ownca_wildcard_privatekey'] }}"

- name: install chart
  kubernetes.core.helm:
    chart_ref: traefik
    chart_repo_url: https://traefik.github.io/charts
    chart_version: "{{ traefik_chart_version }}"
    release_name: traefik
    release_namespace: traefik
    release_values:
      global:
        checkNewVersion: false
        sendAnonymousUsage: false
      ingressRoute:
        dashboard:
          enabled: true
          entryPoints:
            - websecure
          matchRule: Host(`traefik.{{ domain_name }}`) && (PathPrefix(`/dashboard`) || PathPrefix(`/api`))
          tls:
            secretName: traefik-dashboard-tls
        healthcheck:
          enabled: true
      ports:
        web:
          http:
            middlewares:
              - traefik-security-headers@kubernetescrd
            redirections:
              entryPoint:
                to: websecure
                scheme: https
                permanent: true
        websecure:
          http:
            middlewares:
              - traefik-security-headers@kubernetescrd
      providers:
        kubernetesGateway:
          enabled: true
      tlsStore:
        default:
          defaultCertificate:
            secretName: wildcard-tls
    wait: true

- name: create security headers middleware
  kubernetes.core.k8s:
    namespace: traefik
    resource_definition:
      apiVersion: traefik.io/v1alpha1
      kind: Middleware
      metadata:
        name: security-headers
      spec:
        headers:
          frameDeny: true
          contentTypeNosniff: true
          browserXssFilter: false
          referrerPolicy: strict-origin-when-cross-origin
          permissionsPolicy: >-
            accelerometer=(),
            camera=(),
            geolocation=(),
            gyroscope=(),
            magnetometer=(),
            microphone=(),
            payment=(),
            usb=()

- name: create dashboard Certificate
  kubernetes.core.k8s:
    namespace: traefik
    resource_definition:
      apiVersion: cert-manager.io/v1
      kind: Certificate
      metadata:
        name: traefik-dashboard
      spec:
        secretName: traefik-dashboard-tls
        duration: 160h
        renewBefore: 24h
        dnsNames:
          - traefik.{{ domain_name }}
        issuerRef:
          name: ownca
          kind: ClusterIssuer

- name: publish DNS
  ansible.builtin.import_role:
    name: unbound
    tasks_from: fragment.yml
  vars:
    unbound_content: |
      server:
        local-data: "traefik.{{ domain_name }}. A {{ lan_ipv4_address }}"
    unbound_dest: local-data-traefik.conf
