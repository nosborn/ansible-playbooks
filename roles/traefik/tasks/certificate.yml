# yamllint disable rule:line-length
---
- name: read existing private key
  ansible.builtin.slurp:
    src: /usr/local/etc/ssl/private/traefik.{{ domain_name }}.key
  register: traefik_privatekey_result
  failed_when: false

- name: read existing certificate
  ansible.builtin.slurp:
    src: /usr/local/etc/ssl/traefik.{{ domain_name }}.crt
  register: traefik_certificate_result
  failed_when: false

- name: issue certificate
  ansible.builtin.import_role:
    name: ownca
    tasks_from: issue.yml
  vars:
    privatekey_content: "{{ traefik_privatekey_result.content | default('') | b64decode }}"
    certificate_content: "{{ traefik_certificate_result.content | default('') | b64decode }}"
    common_name: traefik.{{ domain_name }}
    subject_alt_name:
      - DNS:traefik.{{ domain_name }}

- name: save private key
  ansible.builtin.copy:
    content: "{{ ownca_privatekey_result.privatekey }}\n"
    dest: /usr/local/etc/ssl/private/traefik.{{ domain_name }}.key
    owner: root
    group: root
    mode: 0400
    validate: openssl rsa -in %s -noout
  ignore_errors: true # FIXME

- name: save certificate
  ansible.builtin.copy:
    content: "{{ ownca_certificate_result.certificate }}\n"
    dest: /usr/local/etc/ssl/traefik.{{ domain_name }}.crt
    owner: root
    group: root
    mode: 0444
    validate: openssl x509 -in %s -noout
  ignore_errors: true # FIXME
