# yamllint disable rule:line-length
---
- name: build bibliogram
  ansible.builtin.import_tasks: build.yml

- name: prepare configuration
  become: false
  delegate_to: localhost
  ansible.builtin.command:
    argv:
      - openssl
      - dgst
    stdin: "{{ lookup('ansible.builtin.template', 'config.js.j2') }}"
  register: bibliogram_config_result
  changed_when: false

- name: create configuration
  community.docker.docker_config:
    name: bibliogram-{{ bibliogram_config_result.stdout | trim }}
    data: "{{ lookup('ansible.builtin.template', 'config.js.j2') }}"
    labels:
      service: bibliogram

- name: create bibliogram volume
  community.docker.docker_volume:
    name: bibliogram

- name: deploy bibliogram
  community.docker.docker_swarm_service:
    name: bibliogram
    image: bibliogram:{{ bibliogram_version }}
    configs:
      - config_name: bibliogram-{{ bibliogram_config_result.stdout | trim }}
        filename: /app/config.js
    env:
      TZ: "{{ timezone }}"
    hostname: bibliogram.{{ domain_name }}
    mounts:
      - source: bibliogram
        target: /app/db
        type: volume
    networks:
      - name: bridge
      - name: traefik
    read_only: true
    labels:
      traefik.enable: !!str true
      traefik.http.middlewares.instagram-redirect.redirectregex.regex: ^https://instagram\\.com/(.*)
      traefik.http.middlewares.instagram-redirect.redirectregex.replacement: https://bibliogram.{{ domain_name }}/$${1}
      traefik.http.routers.bibliogram.entrypoints: websecure
      traefik.http.routers.bibliogram.rule: Host(`bibliogram.{{ domain_name }}`)
      traefik.http.routers.instagram.entrypoints: websecure
      traefik.http.routers.instagram.middlewares: instagram-redirect@docker
      traefik.http.routers.instagram.rule: Host(`instagram.com`)
      traefik.http.routers.instagram.service: bibliogram
      traefik.http.services.bibliogram.loadbalancer.server.port: !!str 10407
    restart_config:
      condition: on-failure
      delay: 20s

- name: issue certificate
  ansible.builtin.import_tasks: certificate.yml
