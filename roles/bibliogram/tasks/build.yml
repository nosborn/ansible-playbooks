---
- name: create source directory
  ansible.builtin.file:
    path: /usr/local/src/bibliogram
    owner: root
    group: root
    mode: 0755
    state: directory

- name: check out source
  ansible.builtin.git:
    repo: https://git.sr.ht/~cadence/bibliogram
    version: master
    dest: /usr/local/src/bibliogram

- name: derive source version
  ansible.builtin.command: # noqa command-instead-of-module
    argv:
      - git
      - log
      - --max-count=1
      - --pretty=format:%as-%h
    chdir: /usr/local/src/bibliogram
  register: bibliogram_version_result
  changed_when: false

- name: set version fact
  ansible.builtin.set_fact:
    bibliogram_version: "{{ bibliogram_version_result.stdout | trim }}"

- name: build container image
  community.docker.docker_image:
    name: bibliogram:{{ bibliogram_version }}
    build:
      path: /usr/local/src/bibliogram
    source: build
