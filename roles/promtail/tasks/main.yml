# yamllint disable rule:line-length
---
- name: create user
  ansible.builtin.user:
    name: promtail
    comment: Promtail Server
    create_home: false
    home: /var/lib/promtail
    password_lock: true
    shell: /usr/sbin/nologin
    system: true

- name: create extract directory
  ansible.builtin.file:
    path: /tmp/promtail-{{ promtail_version }}
    owner: root
    group: root
    mode: 0700
    state: directory

- name: download and unpack release
  ansible.builtin.unarchive:
    src: https://github.com/grafana/loki/releases/download/v{{ promtail_version }}/promtail-linux-amd64.zip
    remote_src: true
    dest: /tmp/promtail-{{ promtail_version }}
    creates: /tmp/promtail-{{ promtail_version }}/promtail-linux-amd64

- name: install binary
  ansible.builtin.copy:
    src: /tmp/promtail-{{ promtail_version }}/promtail-linux-amd64
    remote_src: true
    dest: /usr/local/sbin/promtail
    owner: root
    group: root
    mode: 0555
  notify: restart promtail

- name: install configuration
  ansible.builtin.template:
    src: local-config.yaml.j2
    dest: /usr/local/etc/promtail-local-config.yaml
    owner: root
    group: promtail
    mode: 0440
    validate: "{{ yamllint_validate_command }}"
  notify: restart promtail

- name: create data directory
  ansible.builtin.file:
    path: /var/lib/promtail
    owner: promtail
    group: promtail
    mode: 0700
    state: directory

- name: install service
  ansible.builtin.template:
    src: promtail.service.j2
    dest: /etc/systemd/system/promtail.service
    owner: root
    group: root
    mode: 0444
  notify: restart promtail

- name: enable and start service
  ansible.builtin.systemd:
    name: promtail.service
    daemon_reload: true
    enabled: true
    state: started
