# yamllint disable rule:line-length
---
- name: create config directory
  ansible.builtin.file:
    path: /var/lib/readarr
    owner: "{{ media_owner }}"
    group: "{{ media_group }}"
    mode: !!str 0750
    state: directory

- ansible.builtin.file:
    path: "{{ media_path }}/{{ readarr_item }}"
    owner: "{{ media_owner }}"
    group: "{{ media_group }}"
    mode: !!str 0750
    state: directory
  loop:
    - media/books
    - torrents/complete/books
    - usenet/complete/books
  loop_control:
    loop_var: readarr_item

- ansible.builtin.include_role:
    name: k3s
    tasks_from: namespace.yml
  vars:
    k3s_name: media

- ansible.builtin.template:
    src: manifest.yaml.j2
    dest: /var/lib/rancher/k3s/server/manifests/readarr.yaml
    owner: root
    group: root
    mode: !!str 0400
    validate: yamllint --strict %s

- ansible.builtin.wait_for:
    path: /var/lib/readarr/config.xml

- name: configure
  community.general.xml:
    path: /var/lib/readarr/config.xml
    xpath: /Config/{{ readarr_item.key }}
    value: "{{ readarr_item.value | string }}"
  loop: "{{ config | ansible.builtin.dict2items }}"
  loop_control:
    loop_var: readarr_item
  vars:
    config:
      AnalyticsEnabled: !!str False
      # AuthenticationRequired: DisabledForLocalAddresses
      LaunchBrowser: !!str False
      # LogDbEnabled: !!str False
      LogLevel: info
      UpdateAutomatically: !!str False
  register: readarr_result

# - name: restart container
#   community.docker.docker_container:
#     comparisons:
#       "*": ignore
#     name: readarr
#     restart: "{{ readarr_result is changed }}"

- name: remove readarr logs database
  ansible.builtin.file:
    path: /var/lib/readarr/{{ readarr_item }}
    state: absent
  loop:
    - logs.db
    - logs.db-shm
    - logs.db-wal
  loop_control:
    loop_var: readarr_item
  when: false

- ansible.builtin.include_role:
    name: media
    tasks_from: site.yml
  vars:
    media_name: readarr
