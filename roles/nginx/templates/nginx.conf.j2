#user  www;
worker_processes {{ ansible_processor_count }};

#load_module "modules/ngx_stream_module.so";

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;
#error_log  syslog:server=unix:/dev/log,severity=notice;

pid /var/www/run/nginx.pid;

worker_rlimit_nofile 1024;
events {
  worker_connections 800;
}

http {
  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  index index.html index.htm;

  #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
  #                  '$status $body_bytes_sent "$http_referer" '
  #                  '"$http_user_agent" "$http_x_forwarded_for"';

  #tcp_nopush     on;

  #keepalive_timeout  0;
  keepalive_timeout  65;

  #gzip  on;

  server_tokens off;

  server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name {{ ansible_fqdn }};
    root /var/www/htdocs;

    add_header Content-Security-Policy "default-src 'self'" always;
    add_header Referrer-Policy "same-origin" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;

    location /.well-known/acme-challenge/ {
      rewrite ^/.well-known/acme-challenge/(.*) /$1 break;
      root /acme/;
    }

    location / {
      return 301 https://$server_name$request_uri;
    }
  }
{% if nginx_ssl_certificate.stat.exists %}

  server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name {{ ansible_fqdn }};
    root /var/www/htdocs;

    ssl_certificate {{ nginx_ssl_certificate.stat.path }};
    ssl_certificate_key /etc/ssl/private/{{ ansible_fqdn }}.key;
    ssl_ciphers TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_ecdh_curve prime256v1:secp384r1;
    ssl_prefer_server_ciphers on;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout 5m;

    add_header Referrer-Policy "same-origin" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;

    location /.well-known/acme-challenge/ {
      rewrite ^/.well-known/acme-challenge/(.*) /$1 break;
      root /acme/;
    }

    location /kibana/ {
      allow "{{ lan_ipv4_subnet }}";
      deny all;

      proxy_buffering off;
      proxy_http_version 1.1;
      proxy_pass http://kibana/;
      proxy_redirect off;
      proxy_set_header Connection "Keep-Alive";
      proxy_set_header Proxy-Connection "Keep-Alive";
    }

    location /monit/ {
      allow "{{ lan_ipv4_subnet }}";
      deny all;

      proxy_buffering off;
      proxy_http_version 1.1;
      proxy_pass http://monit/;
      proxy_redirect off;
      proxy_set_header Connection "Keep-Alive";
      proxy_set_header Proxy-Connection "Keep-Alive";

      add_header Content-Security-Policy "default-src 'self'; style-src 'self' 'unsafe-inline'" always;
    }

    location / {
      add_header Content-Security-Policy "default-src 'self'" always;
    }
  }

  upstream kibana {
    server 127.0.0.1:5601;
    keepalive 15;
  }

  upstream monit {
    server 127.0.0.1:2812;
    keepalive 15;
  }
{% endif %}
}
