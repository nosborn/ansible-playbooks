worker_processes 1;

pid /var/run/nginx.pid;

worker_rlimit_nofile 1024;
events {
  worker_connections 800;
}

http {
  include /etc/nginx/mime.types;
  default_type application/octet-stream;
  index index.html;

  #tcp_nopush on;

  #keepalive_timeout 0;
  keepalive_timeout 65;

  #gzip on;

  server_tokens off;

  upstream monit {
    server unix:/run/monit.sock;
  }

  server {
    listen 80 default;
    listen [::]:80 default;
    server_name {{ ansible_fqdn }};
    root /var/www/htdocs;

    add_header Content-Security-Policy "default-src 'none';" always;
    add_header Permissions-Policy "interest-cohort=()" always;
    add_header Referrer-Policy "same-origin" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;

    location /.well-known/acme-challenge/ {
      rewrite ^/.well-known/acme-challenge/(.*) /$1 break;
      root /acme/;
    }

    location / {
      return 301 https://$server_name$request_uri;
    }
  }
{% if nginx_ssl_certificate.stat.exists %}

  server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name {{ ansible_fqdn }};
    root /var/www/htdocs;

    ssl_certificate /etc/ssl/{{ ansible_fqdn }}.fullchain.pem;
    ssl_certificate_key /etc/ssl/private/{{ ansible_fqdn }}.key;
    ssl_ciphers TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_ecdh_curve prime256v1:secp384r1;
    ssl_prefer_server_ciphers on;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout 5m;
    ssl_stapling on;
    ssl_stapling_verify on;

    add_header Content-Security-Policy "default-src 'none'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self'; upgrade-insecure-requests" always;
    add_header Permissions-Policy "interest-cohort=()" always;
    add_header Referrer-Policy "same-origin" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;

    location /.well-known/acme-challenge/ {
      rewrite ^/.well-known/acme-challenge/(.*) /$1 break;
      root /acme/;
    }

{%   if lan_ipv4_subnet is defined %}
    location /monit/ {
      allow {{ lan_ipv4_subnet }};
      allow 2406:3003:2077:1f08::/64;
      deny all;

      proxy_pass http://monit/;
    }

    location = /smokeping/smokeping.fcgi {
      allow {{ lan_ipv4_subnet }};
      allow 2406:3003:2077:1f08::/64;
      deny all;

      include /etc/nginx/fastcgi_params;
      fastcgi_intercept_errors on;
      fastcgi_pass unix:/run/smokeping.sock;
    }

    location ^~ /smokeping/ {
      allow {{ lan_ipv4_subnet }};
      allow 2406:3003:2077:1f08::/64;
      deny all;

      index smokeping.fcgi;
      gzip off;
    }
{%   endif %}
  }
{% endif %}
}
