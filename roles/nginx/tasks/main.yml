# roles/nginx/tasks/main
---
- name: install package
  package: name=nginx state=present

- name: sites configuration directory
  file:
    path=/etc/nginx/conf.d state=directory
    owner=root group=root mode=0755

- name: main configuration file
  template:
    src=nginx.conf.j2 dest=/etc/nginx/nginx.conf
    owner=root group=root mode=0444
    validate='nginx -c %s -t'
  notify: restart nginx

- name: enable and start service
  service: name=nginx enabled=yes state=started

- name: configure sites
  include_tasks: site.yml site={{ nginx_item }}
  with_items: "{{ sites }}"
  loop_control:
    loop_var: nginx_item
...
