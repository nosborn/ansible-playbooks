# roles/nginx/tasks/site
---
- include_tasks: roles/letsencrypt/tasks/domain.yml domain={{ site.name }}
  notify: restart nginx

- file:
    path={{ item }} state=directory
    owner=root group=wheel mode=0775
    backup=yes
  with_items:
    - /var/www/sites/{{ site.name }}
    - /var/www/sites/{{ site.name }}/shared
  when: site.redirect is not defined

- name: create htpasswd file
  when: item.auth_basic_user_file is defined
  copy:
    content={{ item.htpasswd|default('') }} dest=/var/www{{ item.auth_basic_user_file }}
    owner=root group=www mode=0440
    backup=yes
  with_items: "{{ site.locations|default([]) }}"
  notify: restart nginx

- template:
    src=site.conf.j2 dest=/etc/nginx/sites.d/{{ site.name }}.conf
    owner=root group=wheel mode=0444
    backup=yes
  notify: restart nginx
...
