# yamllint disable rule:line-length
---
- name: prepare configuration
  become: false
  delegate_to: localhost
  ansible.builtin.command:
    argv:
      - openssl
      - dgst
    stdin: "{{ lookup('ansible.builtin.template', 'nginx/nginx.conf.j2') }}"
  register: scribe_nginx_config_result
  changed_when: false

- name: create configuration
  community.docker.docker_config:
    name: scribe-nginx-{{ scribe_nginx_config_result.stdout | trim }}
    data: "{{ lookup('ansible.builtin.template', 'nginx/nginx.conf.j2') }}"
    labels:
      service: scribe-nginx

- name: prepare site configuration
  become: false
  delegate_to: localhost
  ansible.builtin.command:
    argv:
      - openssl
      - dgst
    stdin: "{{ lookup('ansible.builtin.template', 'nginx/conf.d/default.conf.j2') }}"
  register: scribe_nginx_default_result
  changed_when: false

- name: create site configuration
  community.docker.docker_config:
    name: scribe-nginx-default-{{ scribe_nginx_default_result.stdout | trim }}
    data: "{{ lookup('ansible.builtin.template', 'nginx/conf.d/default.conf.j2') }}"
    labels:
      service: scribe-nginx

- name: deploy nginx
  community.docker.docker_swarm_service:
    name: scribe-nginx
    image: nginx:mainline-alpine
    configs:
      - config_name: scribe-nginx-{{ scribe_nginx_config_result.stdout | trim }}
        filename: /etc/nginx/nginx.conf
      - config_name: scribe-nginx-default-{{ scribe_nginx_default_result.stdout | trim }}
        filename: /etc/nginx/conf.d/default.conf
    env:
      TZ: "{{ timezone }}"
    hostname: scribe-nginx.{{ domain_name }}
    networks:
      - name: bridge
      - name: scribe
      - name: traefik
    labels:
      traefik.enable: !!str true
      traefik.http.routers.scribe.entrypoints: websecure
      traefik.http.routers.scribe.rule: Host(`scribe.{{ domain_name }}`) || Host(`medium.com`) || Host(`*.medium.com`)
      traefik.http.routers.scribe.service: scribe
      traefik.http.services.scribe.loadbalancer.server.port: !!str 80
    restart_config:
      condition: on-failure
      delay: 20s

- name: issue certificate
  ansible.builtin.import_tasks: certificate.yml
