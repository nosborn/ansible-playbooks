---
- name: create source directory
  ansible.builtin.file:
    path: /usr/local/src/scribe
    owner: root
    group: root
    mode: 0755
    state: directory

- name: check out source
  ansible.builtin.git:
    repo: https://git.sr.ht/~edwardloveall/scribe
    version: main
    dest: /usr/local/src/scribe

- name: derive source version
  ansible.builtin.command: # noqa command-instead-of-module
    argv:
      - git
      - log
      - --max-count=1
      - --pretty=format:%as-%h
    chdir: /usr/local/src/scribe
  register: scribe_version_result
  changed_when: false

- name: set version fact
  ansible.builtin.set_fact:
    scribe_version: "{{ scribe_version_result.stdout | trim }}"

- name: build container image
  community.docker.docker_image:
    name: scribe:{{ scribe_version }}
    build:
      args:
        PGID: "{{ scribe_user_result.group }}"
        PUID: "{{ scribe_user_result.group }}"
      path: /usr/local/src/scribe
    source: build
