---
- name: create user
  ansible.builtin.user:
    name: scribe
    comment: Medium Frontend
    create_home: false
    home: /var/empty
    password_lock: true
    shell: /usr/sbin/nologin
    system: true
  register: scribe_user_result

- name: build scribe
  ansible.builtin.import_tasks: build.yml

- name: create network
  community.docker.docker_network:
    name: scribe
    driver: overlay
    internal: true
    scope: swarm

- name: deploy service
  community.docker.docker_swarm_service:
    name: scribe
    image: scribe:{{ scribe_version }}
    env:
      APP_DOMAIN: scribe.{{ domain_name }}
      DATABASE_URL: postgres://does@not/matter
      # GITHUB_PERSONAL_ACCESS_TOKEN:
      # GITHUB_USERNAME:
      LUCKY_ENV: production
      PORT: "{{ scribe_port | string }}"
      SECRET_KEY_BASE: "{{ scribe_secret_key_base }}"
      TZ: "{{ timezone }}"
    hostname: scribe.{{ domain_name }}
    networks:
      - name: bridge
      - name: scribe
    user: "{{ scribe_user_result.uid }}:{{ scribe_user_result.group }}"
    labels:
      traefik.enable: !!str false
    restart_config:
      condition: on-failure
      delay: 20s
    update_config:
      order: start-first

- name: deploy nginx
  ansible.builtin.import_tasks: nginx.yml
