# yamllint disable rule:line-length
---
- name: "snmp : install packages"
  ansible.builtin.apt:
    name: prometheus-snmp-exporter
  register: result

- name: "snmp : register package facts"
  ansible.builtin.package_facts:
    manager: apt

- name: "snmp : build generator"
  ansible.builtin.import_tasks: snmp-generator.yml
  vars:
    version: "{{ packages['prometheus-snmp-exporter'][0].version | regex_replace('^[0-9]+:', '') | regex_replace('-.+$', '') }}"

- name: "snmp : configure defaults"
  ansible.builtin.lineinfile:
    path: /etc/default/prometheus-snmp-exporter
    regexp: ^ARGS=
    line: ARGS="--config.file=/etc/prometheus/snmp.yml --web.listen-address=localhost:{{ prometheus_snmp_exporter_port }}"
    owner: root
    group: root
    mode: 0444
    validate: sh -n %s
  notify: restart prometheus-snmp-exporter

- name: "snmp : install configuration"
  ansible.builtin.template:
    src: snmp.yml.j2
    dest: /etc/prometheus/snmp.yml
    owner: root
    group: root
    mode: 0444
    # validate: "{{ yamllint_validate_command }}"
  notify: restart prometheus-snmp-exporter

- name: "snmp : enable and start service"
  ansible.builtin.systemd:
    name: prometheus-snmp-exporter
    enabled: true
    state: started
