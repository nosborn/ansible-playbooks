---
- name: install package
  become: false
  ansible.builtin.package:
    name: get_iplayer
    state: present

- name: create directories
  become: false
  ansible.builtin.file:
    path: "{{ item }}"
    owner: "{{ ansible_user }}"
    mode: 0700
    state: directory
  loop:
    - "{{ lookup('env', 'HOME') }}/.get_iplayer"
    - "{{ lookup('env', 'HOME') }}/.get_iplayer/pvr"

- name: create options file
  become: false
  ansible.builtin.template:
    src: options.j2
    dest: "{{ lookup('env', 'HOME') }}/.get_iplayer/options"
    owner: "{{ ansible_user }}"
    mode: 0400

- name: create PVR files
  become: false
  ansible.builtin.template:
    src: show.j2
    dest: "{{ lookup('env', 'HOME') }}/.get_iplayer/pvr/{{ item.key }}"
    owner: "{{ ansible_user }}"
    mode: 0400
  with_dict: "{{ get_iplayer_pvr_shows }}"

- name: refresh index
  become: false
  ansible.builtin.command:
    argv:
      - /usr/local/bin/get_iplayer
      - --refresh
      - --refresh-limit=30
      - --silent
    creates: "{{ lookup('env', 'HOME') }}/.get_iplayer/tv.cache"

- name: schedule PVR
  become: false
  ansible.builtin.cron:
    name: get_iplayer PVR
    hour: 0,8,16
    job: /usr/local/bin/get_iplayer --pvr --silent
    state: present
