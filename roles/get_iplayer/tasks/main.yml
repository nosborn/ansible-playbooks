# yamllint disable rule:line-length
---
- name: create build directory
  file:
    path: "{{ get_iplayer_image_build_path }}"
    owner: root
    group: root
    mode: 0700
    state: directory

- name: upload build files
  template:
    src: "{{ item }}.j2"
    dest: "{{ get_iplayer_image_build_path }}/{{ item }}"
    owner: root
    group: root
    mode: 0400
  loop:
    - Dockerfile
    - pvr

- name: build image
  docker_image:
    name: "{{ get_iplayer_image_name }}"
    build:
      dockerfile: Dockerfile
      path: "{{ get_iplayer_image_build_path }}"
      pull: true
    source: build

- name: create persistent storage
  file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: 0755
    state: directory
  loop:
    - "{{ docker_persistent_storage }}/{{ get_iplayer_container_name }}"
    - "{{ docker_persistent_storage }}/{{ get_iplayer_container_name }}/pvr"

- name: upload configuration file
  template:
    src: options.j2
    dest: "{{ docker_persistent_storage }}/{{ get_iplayer_container_name }}/options"
    owner: root
    group: root
    mode: 0444
  notify: restart get_iplayer

- name: upload PVR configuration files
  template:
    src: show.j2
    dest: "{{ docker_persistent_storage }}/{{ get_iplayer_container_name }}/pvr/{{ item.key }}"
    owner: root
    group: root
    mode: 0444
  with_dict: "{{ get_iplayer_pvr_shows }}"

- name: create container
  docker_container:
    name: "{{ get_iplayer_container_name }}"
    dns_servers: "{{ mediastreamer_dns }}"
    env:
      GETIPLAYER_PROFILE: /get_iplayer
    image: "{{ get_iplayer_image_name }}"
    init: true
    networks:
      - name: macvlan
        ipv4_address: "{{ get_iplayer_ipv4_address }}"
    networks_cli_compatible: true
    restart_policy: unless-stopped
    volumes:
      - "{{ docker_persistent_storage }}/{{ get_iplayer_container_name }}/:/get_iplayer/"
      - /volume1/video/:/video/
