# roles/opensmtpd/tasks/main
---
- include_vars: vault.yml
  no_log: true

- name: install package
  package: name=opensmtpd state=present

- copy:
    content="{{ mail_aliases }}" dest=/etc/smtpd/aliases
    owner=root group=root mode=0444
  notify: update aliases table

- copy:
    content="{{ smtpd_secrets_table }}" dest=/etc/smtpd/secrets
    owner=root group=smtpd mode=0440
  notify: update secrets table

- template:
    src=smtpd.conf.j2 dest=/etc/smtpd/smtpd.conf
    owner=root group=root mode=0444
    validate='/usr/sbin/smtpd -f %s -n'
  notify: restart smtpd

- name: start SMTP daemon
  service: name=smtpd enabled=yes state=started
...
