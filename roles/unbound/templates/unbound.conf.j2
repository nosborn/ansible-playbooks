server:
	verbosity: 1

	extended-statistics: yes

{% for interface in unbound_config_interfaces %}
	interface: {{ interface }}
{% endfor %}

{% if unbound_outgoing_port_avoid | length %}
{%   for port in unbound_outgoing_port_avoid %}
	outgoing-port-avoid: {{ port }}
{%   endfor %}

{% endif %}
	ip-freebind: yes

	prefer-ip6: yes

	edns-tcp-keepalive: yes

	msg-cache-size: 32m
	msg-cache-slabs: 2

	rrset-cache-size: 64m
	rrset-cache-slabs: 2

	infra-cache-slabs: 2

{% for access_control in unbound_config_access_controls %}
	access-control: {{ access_control }}
{% endfor %}

	log-queries: yes
	# log-replies: yes
	log-tag-queryreply: yes
	log-servfail: yes

	hide-identity: yes
	hide-version: yes

	private-address: 0.0.0.0/8
	private-address: 10.0.0.0/8         # Private-Use
	private-address: 100.64.0.0/10      # Shared Address Space
	private-address: 127.0.0.0/8        # Loopback
	private-address: 169.254.0.0/16     # Link Local
	private-address: 172.16.0.0/12      # Private-Use
	private-address: 192.0.2.0/24       # Documentation (TEST-NET-1)
	private-address: 192.168.0.0/16     # Private-Use
	private-address: 198.18.0.0/15      # Benchmarking
	private-address: 198.51.100.0/24    # Documentation (TEST-NET-2)
	private-address: 203.0.113.0/24     # Documentation (TEST-NET-3)
	private-address: 240.0.0.0/4        # Reserved
	private-address: 255.255.255.255/32 # Limited Broadcast
	private-address: fd00::/8
	private-address: fe80::/10
	private-address: ::ffff:0:0/96      # IPv4-mapped IPv6 addresses
	private-domain: "{{ domain_name }}"

	prefetch: yes
	prefetch-key: yes
	deny-any: yes

{% if unbound_config_module_config is defined %}
	module-config: "{{ unbound_config_module_config | join(' ') }}"

{% endif %}

{% if smartdns_domains is defined %}
{%   for domain in smartdns_domains %}
	domain-insecure: "{{ domain }}"
{%   endfor %}

{% endif %}
	val-log-level: 2

	serve-expired: yes
	serve-expired-ttl: 86400
	serve-expired-ttl-reset: yes
	serve-expired-reply-ttl: 30
	serve-expired-client-timeout: 1800

	key-cache-slabs: 2

	# https://support.mozilla.org/en-US/kb/canary-domain-use-application-dnsnet
	local-zone: "use-application-dns.net." static

{% if inventory_hostname == 'tombstone' %}
	# DNS-over-HTTPS
	local-zone: "doh.dns.apple.com." static

	local-zone: "{{ domain_name }}." static
	local-zone: "local." static

	local-data: "tombstone.{{ domain_name }}. A {{ hostvars.tombstone.lan_ipv4_address }}"
	local-data: "tombstone.{{ domain_name }}. AAAA {{ hostvars.tombstone.lan_ipv6_address }}"
	local-data: "uck-g2.{{ domain_name }}. A {{ hostvars['uck-g2'].lan_ipv4_address }}"
	local-data: "usg.{{ domain_name }}. A {{ hostvars.usg.lan_ipv4_address }}"

	local-data: "bibliogram.{{ domain_name }}. CNAME tombstone.{{ domain_name }}."
	local-data: "grafana.{{ domain_name }}. CNAME tombstone.{{ domain_name }}."
	local-data: "invidious.{{ domain_name }}. CNAME tombstone.{{ domain_name }}."
	local-data: "nitter.{{ domain_name }}. CNAME tombstone.{{ domain_name }}."
	local-data: "rimgo.{{ domain_name }}. CNAME tombstone.{{ domain_name }}."
	local-data: "scribe.{{ domain_name }}. CNAME tombstone.{{ domain_name }}."
	local-data: "teddit.{{ domain_name }}. CNAME tombstone.{{ domain_name }}."
	local-data: "traefik.{{ domain_name }}. CNAME tombstone.{{ domain_name }}."

	private-domain: "imgur.com"
	domain-insecure: "imgur.com"
	local-zone: "imgur.com." redirect
	# local-data: "imgur.com. A tombstone.{{ domain_name }}."
	# local-data: "imgur.com. AAAA tombstone.{{ domain_name }}."
	local-data: "imgur.com. CNAME bibliogram.{{ domain_name }}."

	private-domain: "instagram.com"
	domain-insecure: "instagram.com"
	local-zone: "instagram.com." redirect
	# local-data: "instagram.com. A tombstone.{{ domain_name }}."
	# local-data: "instagram.com. AAAA tombstone.{{ domain_name }}."
	local-data: "instagram.com. CNAME bibliogram.{{ domain_name }}."

	private-domain: "medium.com"
	domain-insecure: "medium.com"
	local-zone: "medium.com." redirect
	# local-data: "medium.com. A tombstone.{{ domain_name }}."
	# local-data: "medium.com. AAAA tombstone.{{ domain_name }}."
	local-data: "medium.com. CNAME scribe.{{ domain_name }}."

	private-domain: "twitter.com"
	domain-insecure: "twitter.com"
	local-zone: "twitter.com." redirect
	# local-data: "twitter.com. A tombstone.{{ domain_name }}."
	# local-data: "twitter.com. AAAA tombstone.{{ domain_name }}."
	local-data: "twitter.com. CNAME scribe.{{ domain_name }}."

	# local-data: "i.imgur.com. CNAME rimgo.{{ domain_name }}."
	# local-data: "imgur.com. CNAME rimgo.{{ domain_name }}."
	# local-data: "instagram.com. CNAME bibliogram.{{ domain_name }}."
	# local-data: "medium.com. CNAME scribe.{{ domain_name }}."
	# # # local-data: "old.reddit.com. CNAME reddit.{{ domain_name }}."
	# # local-data: "old.reddit.com. A {{ hostvars.tombstone.lan_ipv4_address }}"
	# local-data: "reddit.com. CNAME teddit.{{ domain_name }}."
	# local-data: "twitter.com. CNAME nitter.{{ domain_name }}."
	# local-data: "youtu.be. CNAME invidious.{{ domain_name }}."
	# local-data: "youtube.com. CNAME invidious.{{ domain_name }}."

	local-data: "unifi.{{ domain_name }}. CNAME uck-g2.{{ domain_name }}."

	local-data-ptr: "{{ hostvars.tombstone.lan_ipv4_address }} tombstone.{{ domain_name }}."
	local-data-ptr: "{{ hostvars.usg.lan_ipv4_address }} usg.{{ domain_name }}."
	local-data-ptr: "{{ hostvars['uck-g2'].lan_ipv4_address }} uck-g2.{{ domain_name }}."

# The following line includes additional configuration files from the
# /etc/unbound/unbound.conf.d directory.
include-toplevel: "/etc/unbound/unbound.conf.d/*.conf"

{% endif %}
# remote-control:
# 	control-enable: yes
# 	control-interface: /var/run/unbound.sock
# 	control-use-cert: no
{% if smartdns_exclusions is defined and unbound_forwarders is defined %}
{%   for domain in smartdns_exclusions %}

forward-zone:
	name: "{{ domain }}."
{%     for address in unbound_forwarders %}
	forward-addr: {{ address }}
{%     endfor %}
{%   endfor %}
{% endif %}
{% if smartdns_domains is defined %}
{%   for domain in smartdns_domains %}

forward-zone:
	name: "{{ domain }}."
{%     for address in smartdns_servers %}
	forward-addr: {{ address }}
{%     endfor %}
{%   endfor %}
{% endif %}
{% if unbound_forwarders is defined %}

forward-zone:
	name: "."
{%   for forwarder in unbound_forwarders %}
	forward-addr: {{ forwarder }}
{%   endfor %}
{% endif %}
