# roles/unbound/tasks/main
---
- name: install packages
  package:
    name:
      - p5-Digest-SHA1
      - p5-IO-Socket-SSL
    state: present

# # - copy:
# #     src=named.cache dest=/var/unbound/etc/named.cache
# #     owner=root group=wheel mode=0444
# #   notify: restart unbound

- name: install blacklist script
  template:
    src: update-dns-blacklist.pl.j2
    dest: /usr/local/libexec/update-dns-blacklist
    owner: root
    group: wheel
    mode: 0550
    validate: /usr/bin/perl -cw %s

- name: create main blacklist
  command: /usr/local/libexec/update-dns-blacklist
  args:
    creates: "{{ unbound_confdir }}/blacklist.conf"
  notify: reload unbound

- name: install additional blacklists
  copy:
    src: "{{ item }}"
    dest: "{{ unbound_confdir }}/{{ item }}"
    owner: root
    group: wheel
    mode: 0444
  with_items:
    - blacklist-doh.conf
  notify: reload unbound

- name: install configuration file
  template:
    src: unbound.conf.j2
    dest: "{{ unbound_confdir }}/unbound.conf"
    owner: root
    group: wheel
    mode: 0444
  notify: restart unbound

- name: create log directory
  file:
    path: "{{ unbound_logdir }}"
    owner: root
    group: _unbound
    mode: 0775
    state: directory

- name: enable and start service
  service:
    name: "{{ unbound_service_name }}"
    enabled: true
    state: started
