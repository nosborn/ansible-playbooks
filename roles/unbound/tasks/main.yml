# roles/unbound/tasks/main
---
- copy:
    src=named.cache dest=/var/unbound/etc/named.cache
    owner=root group=wheel mode=0444
    backup=yes
  notify: reload unbound

- template:
    src={{ item }}.j2 dest=/var/unbound/etc/{{ item }}
    owner=root group=wheel mode=0444
    backup=yes
  with_items:
    - domains
    - hosts
  notify: reload unbound

- name: setup the root trust anchor
  command: /usr/sbin/unbound-anchor
  args:
    creates: /var/unbound/db/root.key
  register: command_result
  failed_when: 'command_result.rc > 1'
  changed_when: 'command_result.rc == 1'
  notify: reload unbound

- command: /usr/sbin/unbound-control-setup
  args:
    creates: /var/unbound/etc/unbound_control.key
  notify: reload unbound

- name: temporary configuration file
  template:
    src=unbound.conf.j2 dest=/var/unbound/etc/.unbound.conf
    owner=root group=wheel mode=0440
    backup=yes

- name: configuration file
  copy:
    src=/var/unbound/etc/.unbound.conf dest=/var/unbound/etc/unbound.conf
    owner=root group=wheel mode=0444
    remote_src=yes
    validate='/usr/sbin/unbound-checkconf %s'
    backup=yes
  notify: reload unbound

- name: start DNS resolver
  service: name=unbound enabled=yes state=started
...
