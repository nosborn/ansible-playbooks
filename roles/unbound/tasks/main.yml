---
- name: install dependencies
  community.general.openbsd_pkg:
    name:
      - p5-Digest-SHA1
      - p5-IO-Socket-SSL
    state: present

- name: create blacklist script
  ansible.builtin.template:
    src: blacklist.pl.j2
    dest: /usr/local/libexec/unbound-blacklist
    owner: root
    group: wheel
    mode: 0550
    validate: /usr/bin/perl -cw %s
  notify: clear unbound blacklist cache

- name: create blacklist
  shell:
    cmd: /usr/local/libexec/unbound-blacklist >/var/unbound/etc/blacklist.conf
    creates: /var/unbound/etc/blacklist.conf
  notify: restart unbound

- name: install DoH blacklist
  ansible.builtin.template:
    src: doh-blacklist.conf.j2
    dest: /var/unbound/etc/doh-blacklist.conf
    owner: root
    group: wheel
    mode: 0444
  notify: restart unbound

- name: install configuration file
  ansible.builtin.template:
    src: unbound.conf.j2
    dest: /var/unbound/etc/unbound.conf
    owner: root
    group: wheel
    mode: 0444
  notify: restart unbound

- name: enable and start service
  ansible.builtin.service:
    name: unbound
    enabled: true
    state: started
