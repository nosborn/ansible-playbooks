# roles/unbound/tasks/main
---
- name: OS-specific variables
  include_vars: "{{ ansible_distribution }}.yml"

- name: install package
  package:
    name: "{{ unbound_package_name }}"
    state: present
  register: unbound_package_result
  until: unbound_package_result is succeeded
  when: unbound_package_name is defined

- name: setup remote server control
  command: /usr/sbin/unbound-control-setup
  args:
    creates: /var/unbound/etc/unbound_control.key
  notify: restart unbound

# - name: setup the root trust anchor
#   command: /usr/sbin/unbound-anchor
#   args:
#     creates: /var/unbound/db/root.key
#   register: command_result
#   failed_when: command_result.rc > 1
#   changed_when: command_result.rc == 1
#   notify: restart unbound
#   when: false

# # - copy:
# #     src=named.cache dest=/var/unbound/etc/named.cache
# #     owner=root group=wheel mode=0444
# #   notify: restart unbound

- name: filter configuration files
  copy:
    src: "{{ item }}"
    dest: /var/unbound/etc/{{ item }}
    owner: root
    group: wheel
    mode: "{{ unbound_mode }}"
  with_items:
    - redirect-zones.conf
  notify: reload unbound

- name: install configuration file
  template:
    src: unbound.conf.j2
    dest: /var/unbound/etc/unbound.conf
    owner: root
    group: wheel
    mode: "{{ unbound_mode }}"
  notify: restart unbound

# - name: resource limits
#   replace:
#     path: /etc/login.conf
#     backup: true
#     regexp: '^(unbound:.+\\n\\s+:openfiles)=\\d+'
#     replace: '\\1=512'
#   notify: restart unbound
#   when: false

- name: enable and start service
  service:
    name: unbound
    enabled: true
    state: started
...
