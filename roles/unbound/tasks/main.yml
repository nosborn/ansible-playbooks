# roles/unbound/tasks/main
---
- name: create build directory
  file:
    path: "{{ unbound_image_build_path }}"
    owner: root
    group: root
    mode: 0700
    state: directory

- name: upload Dockerfile
  template:
    src: Dockerfile.j2
    dest: "{{ unbound_image_build_path }}/Dockerfile"
    owner: root
    group: root
    mode: 0400

- name: build image
  docker_image:
    name: "{{ unbound_image_name }}"
    build:
      dockerfile: Dockerfile
      path: "{{ unbound_image_build_path }}"
      pull: true
    source: build

- name: create persistent storage
  file:
    path: /volume1/docker/unbound
    owner: root
    group: root
    mode: 0755
    state: directory

- template:
    src: unbound.conf.j2
    dest: /volume1/docker/unbound/unbound.conf
    owner: root
    group: root
    mode: 0644
  notify: restart unbound

- name: create container
  docker_container:
    name: "{{ unbound_container_name }}"
    dns_servers:
      - "{{ hostvars['usg']['lan_ipv4_address'] }}"
    image: "{{ unbound_image_name }}"
    init: true
    network_mode: bridge
    restart_policy: always
    volumes:
      - /volume1/docker/unbound/unbound.conf:/etc/unbound/unbound.conf:ro
