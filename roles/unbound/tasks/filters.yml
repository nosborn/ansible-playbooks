---
- name: install dependencies
  import_role:
    name: curl

- name: install dependencies
  ansible.builtin.package:
    name:
      - dos2unix
      - dos2unix-doc
    state: present
  register: unbound_result
  until: unbound_result is not failed

- name: install scripts
  ansible.builtin.copy:
    src: unbound-make-rpz.sh
    dest: /usr/local/bin/unbound-make-rpz.sh
    owner: root
    group: root
    mode: !!str 0555
    validate: /bin/sh -n %s

- name: build RPZ
  ansible.builtin.command:
    argv:
      - /usr/local/bin/unbound-make-rpz.sh
    creates: /etc/unbound/rpz.home.arpa.zone

- name: install cron jobs
  ansible.builtin.copy:
    content: |
      #!/bin/sh
      exec /usr/local/bin/unbound-make-rpz.sh
    dest: /etc/periodic/daily/unbound-make-rpz
    owner: root
    group: root
    mode: !!str 0555
    validate: /bin/sh -n %s
