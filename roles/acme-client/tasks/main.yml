# roles/letsencrypt/tasks/main
---
- name: install account key
  copy:
    content: "{{ letsencrypt_account_key }}"
    dest: "{{ acme_account_key_file }}"
    owner: root
    group: wheel
    mode: 0400

- name: install staging account key
  copy:
    content: "{{ letsencrypt_staging_account_key }}"
    dest: "{{ acme_staging_account_key_file }}"
    owner: root
    group: wheel
    mode: 0400
  when: letsencrypt_staging_account_key is defined

- name: install configuration file
  template:
    src: acme-client.conf.j2
    dest: /etc/acme-client.conf
    owner: root
    group: wheel
    mode: 0444
    validate: /usr/sbin/acme-client -n -f %s {{ ansible_fqdn }}

- name: create certificate
  command: /usr/sbin/acme-client -D {{ ansible_fqdn }}
  args:
    creates: /etc/ssl/{{ ansible_fqdn }}.crt
  notify:
    - restart nginx

- fetch:
    src: "{{ item }}"
    dest: backup
    fail_on_missing: true
  with_items:
    - /etc/ssl/{{ ansible_fqdn }}.crt
    - /etc/ssl/{{ ansible_fqdn }}.chain.pem
    - /etc/ssl/{{ ansible_fqdn }}.fullchain.pem
    - /etc/ssl/private/{{ ansible_fqdn }}.key
...
