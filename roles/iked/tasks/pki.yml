# roles/iked/tasks/pki
---
- name: create certificate authority
  command: ikectl -q ca vpn create password '{{ ikeca_password }}'
  args:
    creates: /etc/ssl/vpn/ca.crt
  environment:
    CERT_C: .
    CERT_L: .
    CERT_O: .
    CERT_OU: iked
    CERT_CN: Osborn.IO VPN CA

- name: create server certificate
  command: ikectl -q ca vpn certificate {{ ansible_fqdn }} create server
  args:
    creates: /etc/ssl/vpn/{{ ansible_fqdn }}.crt
  environment:
    CERT_C: .
    CERT_L: .
    CERT_O: .
    CERT_OU: iked
    CERT_CN: "{{ ansible_fqdn }}"

- name: install server certificate
  command: ikectl -q ca vpn certificate {{ ansible_fqdn }} install
  args:
    creates: /etc/iked/certs/{{ ansible_fqdn }}.crt
  when: false

- name: create client certificates
  command: ikectl -q ca vpn certificate {{ item }} create client
  args:
    creates: /etc/ssl/vpn/{{ item }}.crt
  environment:
    CERT_C: .
    CERT_L: .
    CERT_O: .
    CERT_OU: iked
    CERT_CN: "{{ item }}"
  with_items:
    - nicks-ipad.{{ global_domain }}
    - nicks-iphone.{{ global_domain }}
  when: false

- name: install CA certificate and CRL
  command: ikectl -q ca vpn install
  args:
    creates: /etc/iked/ca/ca.crt
  when: false

- fetch:
    dest=backup fail_on_missing=no src={{ item }}
  # dest=backup fail_on_missing=yes src={{ item }}
  with_items:
    - /etc/iked/local.pub
    - /etc/iked/private/local.key
    - /etc/ssl/vpn/ca.crl
    - /etc/ssl/vpn/ca.crt
    - /etc/ssl/vpn/{{ ansible_fqdn }}.crt
    - /etc/ssl/vpn/index.txt
    - /etc/ssl/vpn/private/ca.key
    - /etc/ssl/vpn/private/{{ ansible_fqdn }}.key
    - /etc/ssl/vpn/serial.txt
...
