# roles/iplayer/tasks/main
---
- name: install package
  openbsd_pkg: name=get_iplayer state=present

- name: create directories
  file:
    dest={{ item }} state=directory
    owner={{ iplayer_pvr_user }} group={{ iplayer_pvr_user }} mode=0750
  with_items:
    - "{{ iplayer_dir }}"
    - "{{ iplayer_dir }}/pvr"

- name: configure options
  template:
    src=options.j2 dest={{ iplayer_dir }}/options
    owner={{ iplayer_pvr_user }} group={{ iplayer_pvr_user }} mode=0440
    backup=yes

- name: configure PVR
  template:
    src=show.j2 dest={{ iplayer_dir }}/pvr/{{ item.key }}
    owner={{ iplayer_pvr_user }} group={{ iplayer_pvr_user }} mode=0440
    backup=yes
  with_dict: "{{ iplayer_pvr_shows }}"

- name: schedule PVR
  cron:
    name='iplayer pvr'
    minute={{ 59|random(seed=inventory_hostname) }}
    hour=0,4,8,12,16,20
    user={{ iplayer_pvr_user }}
    job="get_iplayer --silent --pvr | mail -E -r iplayer -s 'iPlayer PVR' {{ iplayer_pvr_mail|join(" ") }}"

- name: schedule purge files
  cron:
    name='iplayer purge-files'
    minute={{ 59|random(seed=inventory_hostname) }}
    hour=2
    user={{ iplayer_pvr_user }}
    job="echo yes | get_iplayer --silent --purge-files"
...
