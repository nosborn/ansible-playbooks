# roles/iplayer/tasks/main
---
- name: install dependencies
  package: name={{ item }} state=present
  with_items:
    - atomicparsley
    - ffmpeg
    # - perl-json-pp -- FIXME
    - perl-libwww
    - perl-lwp-protocol-https
    - perl-xml-libxml

- name: download distribution
  unarchive:
    src=https://github.com/get-iplayer/get_iplayer/archive/v{{ iplayer_version }}.tar.gz
    remote_src=yes dest=/tmp
    creates=/tmp/get_iplayer-{{ iplayer_version }}/get_iplayer

- name: insall script
  copy:
    src=/tmp/get_iplayer-{{ iplayer_version }}/get_iplayer
    remote_src=yes dest=/usr/local/bin/get_iplayer
    owner=root group=root mode=0555

- file:
    path=/usr/local/man/man1 state=directory
    owner=root group=root mode=0555

- name: install man page
  copy:
    src=/tmp/get_iplayer-{{ iplayer_version }}/get_iplayer.1
    remote_src=yes dest=/usr/local/man/man1/get_iplayer.1
    owner=root group=root mode=0444

- name: create directories
  file:
    path={{ item }} state=directory
    owner={{ iplayer_pvr_user }} group={{ iplayer_pvr_user }} mode=0750
  with_items:
    - "{{ iplayer_dir }}"
    - "{{ iplayer_dir }}/pvr"

- name: configure options
  template:
    src=options.j2 dest={{ iplayer_dir }}/options
    owner={{ iplayer_pvr_user }} group={{ iplayer_pvr_user }} mode=0440

- name: configure PVR
  template:
    src=show.j2 dest={{ iplayer_dir }}/pvr/{{ item.key }}
    owner={{ iplayer_pvr_user }} group={{ iplayer_pvr_user }} mode=0440
  with_dict: "{{ iplayer_pvr_shows }}"

- name: schedule PVR
  cron:
    name='iplayer pvr'
    minute={{ 59|random(seed=inventory_hostname) }}
    hour=0,4,8,12,16,20
    user={{ iplayer_pvr_user }}
    job="/usr/local/bin/get_iplayer --silent --pvr | mail -E -r iplayer@{{ ansible_fqdn }} -s 'iPlayer PVR' {{ iplayer_pvr_mail|join(" ") }}"

- name: schedule purge files
  cron:
    name='iplayer purge-files'
    minute={{ 59|random(seed=inventory_hostname) }}
    hour=2
    user={{ iplayer_pvr_user }}
    job="echo yes | /usr/local/bin/get_iplayer --silent --purge-files"
...
