# roles/squid/tasks/main
---
- include_vars: vault.yml
  no_log: true

- name: install package
  openbsd_pkg: name=squid state=present

#- copy:
#    content="{{ squid_ssl_bump_cert }}" dest=/etc/squid/bumpca.pem
#    owner=root group=wheel mode=0400
#    backup=yes
#  notify: restart squid

- name: Error page stylesheet
  copy:
    src=errorpage.css dest=/etc/squid/errorpage.css
    owner=root group=wheel mode=0444
    backup=yes
  notify: reload squid

- name: url_rewriter script
  copy:
    src=url_rewriter.py dest=/usr/local/libexec/squid/url_rewriter
    owner=root group=wheel mode=0555
    validate='/usr/local/bin/python -mpy_compile %s'
    backup=yes
  notify: reload squid

- name: configure HTTP web proxy caching server
  template:
    src=squid.conf.j2 dest=/etc/squid/squid.conf
    owner=root group=wheel mode=0444
    validate='/usr/local/sbin/squid -f %s -k parse'
    backup=yes
  notify: restart squid

# FIXME:
#- name: initialise SSL certificate database directory
#  command: /usr/local/libexec/squid/ssl_crtd -c -s /var/squid/ssl_db
#  args:
#    creates: /var/squid/ssl_db/index.txt
#  become: true
#  become_user: _squid

- name: start squid
  service: name=squid enabled={{ squid_enabled }} state={{ squid_state }}

- lineinfile:
    path=/etc/newsyslog.conf
    regexp='^/var/squid/logs/access.log\s'
    line='/var/squid/logs/access.log\t_squid:_squid\t640  4     *    $W0   ZB /var/run/squid.pid SIGUSR1'
    backup=yes

- lineinfile:
    path=/etc/newsyslog.conf
    regexp='^/var/squid/logs/cache.log\s'
    line='/var/squid/logs/cache.log\t_squid:_squid\t640  7     250  *     ZB /var/run/squid.pid SIGUSR1'
    backup=yes

- lineinfile:
    path=/etc/newsyslog.conf
    regexp='^/var/squid/logs/icap.log\s'
    line='/var/squid/logs/icap.log\t_squid:_squid\t640  4     *    $W0   ZB /var/run/squid.pid SIGUSR1'
    backup=yes
  when: c_icap_port is defined

- lineinfile:
    path=/etc/newsyslog.conf
    regexp='^/var/squid/logs/icap.log\s'
    state=absent
    backup=yes
  when: c_icap_port is not defined
...
