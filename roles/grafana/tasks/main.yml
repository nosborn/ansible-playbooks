# yamllint disable rule:line-length
---
- name: configure signing key
  ansible.builtin.get_url:
    url: https://apt.grafana.com/gpg.key
    dest: /etc/apt/keyrings/grafana.asc
    owner: root
    group: root
    mode: !!str 0444
  register: grafana_result

- name: configure repository
  ansible.builtin.apt_repository:
    repo: deb [signed-by={{ grafana_result.dest }}] https://apt.grafana.com stable main
    state: present

- name: install package
  ansible.builtin.apt:
    name: grafana
    install_recommends: false
    state: present

- name: configuration
  ansible.builtin.template:
    src: grafana.ini.j2
    dest: /etc/grafana/grafana.ini
    owner: root
    group: grafana
    mode: !!str 0440
  notify: restart grafana-server

- name: provisioning
  ansible.builtin.template:
    src: provisioning/{{ item }}.yaml.j2
    dest: /etc/grafana/provisioning/{{ item }}.yaml
    owner: root
    group: grafana
    mode: !!str 0440
  loop:
    - datasources/github
  notify: restart grafana-server

- name: install plugins
  command:
    argv:
      - grafana-cli
      - plugins
      - install
      - "{{ item }}"
    creates: /var/lib/grafana/plugins/{{ item }}
  loop:
    - grafana-github-datasource
  notify: restart grafana-server

- name: enable and start service
  ansible.builtin.systemd:
    name: grafana-server.service
    enabled: true
    state: started
