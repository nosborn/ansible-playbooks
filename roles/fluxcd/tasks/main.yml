# yamllint disable rule:line-length
---
- name: generate manifests
  delegate_to: localhost
  ansible.builtin.command:
    argv:
      - flux
      - install
      - --export
  changed_when: false
  register: fluxcd_result

- name: apply manifests
  kubernetes.core.k8s:
    apply: true
    namespace: flux-system
    resource_definition: "{{ fluxcd_result.stdout }}"
    server_side_apply:
      field_manager: ansible

- name: deployments GitRepository
  kubernetes.core.k8s:
    apply: true
    resource_definition:
      apiVersion: source.toolkit.fluxcd.io/v1
      kind: GitRepository
      metadata:
        name: flux-system
        namespace: flux-system
      spec:
        interval: 1m
        ref:
          branch: main
        url: https://github.com/nosborn/deployments.git
    server_side_apply:
      field_manager: ansible

- name: deployments Kustomization
  kubernetes.core.k8s:
    apply: true
    resource_definition:
      apiVersion: kustomize.toolkit.fluxcd.io/v1
      kind: Kustomization
      metadata:
        name: flux-system
        namespace: flux-system
      spec:
        interval: 10m
        path: ./clusters/tombstone
        prune: true
        sourceRef:
          kind: GitRepository
          name: flux-system
    server_side_apply:
      field_manager: ansible

- name: GitHub token Secret
  kubernetes.core.k8s:
    apply: true
    resource_definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: github-token
        namespace: flux-system
      stringData:
        token: "{{ fluxcd_github_token }}"
      type: Opaque
    server_side_apply:
      field_manager: ansible

- name: Provider
  kubernetes.core.k8s:
    apply: true
    resource_definition:
      apiVersion: notification.toolkit.fluxcd.io/v1beta3
      kind: Provider
      metadata:
        name: github
        namespace: flux-system
      spec:
        address: https://github.com/nosborn/deployments
        secretRef:
          name: github-token
        type: github
    server_side_apply:
      field_manager: ansible

- kubernetes.core.k8s:
    apply: true
    resource_definition:
      apiVersion: notification.toolkit.fluxcd.io/v1beta3
      kind: Alert
      metadata:
        name: github-status
        namespace: flux-system
      spec:
        eventSources:
          - kind: GitRepository
            name: "*"
          - kind: Kustomization
            name: "*"
        providerRef:
          name: github
    server_side_apply:
      field_manager: ansible

- name: GitHub Receiver
  kubernetes.core.k8s:
    apply: true
    resource_definition:
      kind: Receiver
      metadata:
        name: github-webhook
        namespace: flux-system
      spec:
        events:
          - ping
          - push
        resources:
          - kind: GitRepository
            name: flux-system
        secretRef:
          name: webhook-secret
        type: github
    server_side_apply:
      field_manager: ansible

- name: GitHub webhook token Secret
  kubernetes.core.k8s:
    apply: true
    resource_definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: webhook-secret
        namespace: flux-system
      stringData:
        token: "{{ fluxcd_github_webhook_token }}"
    server_side_apply:
      field_manager: ansible
