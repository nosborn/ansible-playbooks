---
- name: install packages
  community.general.openbsd_pkg:
    name: "{{ item }}"
    state: present
  loop:
    - loki
    - loki-promtail

- name: configure loki
  ansible.builtin.template:
    src: loki-config.yaml.j2
    dest: /etc/loki/loki-config.yaml
    owner: root
    group: _loki
    mode: !!str 0440
  notify: restart loki

- name: configure promtail
  ansible.builtin.template:
    src: promtail-config.yaml.j2
    dest: /etc/promtail/promtail-config.yaml
    owner: root
    group: _loki
    mode: !!str 0440
  notify: restart promtail

- name: enable and start services
  ansible.builtin.service:
    name: loki
    enabled: true
    state: started
  loop:
    - loki
    - promtail
