# yamllint disable rule:line-length
---
- name: create user
  ansible.builtin.user:
    name: loki
    comment: Loki Server
    create_home: false
    home: /var/lib/loki
    password_lock: true
    shell: /usr/sbin/nologin
    system: true

- name: create extract directory
  ansible.builtin.file:
    path: /tmp/loki-{{ loki_version }}
    owner: root
    group: root
    mode: 0700
    state: directory

- name: download and unpack release
  ansible.builtin.unarchive:
    src: https://github.com/grafana/loki/releases/download/v{{ loki_version }}/loki-linux-amd64.zip
    remote_src: true
    dest: /tmp/loki-{{ loki_version }}
    creates: /tmp/loki-{{ loki_version }}/loki-linux-amd64

- name: install binary
  ansible.builtin.copy:
    src: /tmp/loki-{{ loki_version }}/loki-linux-amd64
    remote_src: true
    dest: /usr/local/sbin/loki
    owner: root
    group: root
    mode: 0555
  notify: restart loki

- name: install configuration
  ansible.builtin.template:
    src: local-config.yaml.j2
    dest: /usr/local/etc/loki-local-config.yaml
    owner: root
    group: loki
    mode: 0440
    validate: "{{ yamllint_validate_command }}"
  notify: restart loki

- name: create data directory
  ansible.builtin.file:
    path: /var/lib/loki
    owner: loki
    group: loki
    mode: 0700
    state: directory

- name: install service
  ansible.builtin.template:
    src: loki.service.j2
    dest: /etc/systemd/system/loki.service
    owner: root
    group: root
    mode: 0444
  notify: restart loki

- name: enable and start service
  ansible.builtin.systemd:
    name: loki.service
    daemon_reload: true
    enabled: true
    state: started
