#	$OpenBSD: pf.conf,v 1.54 2014/08/23 05:49:42 deraadt Exp $
#
# See pf.conf(5) and /etc/examples/pf.conf

#set skip on lo

match out on rdomain 0 to {{ lan_ipv4|ipaddr('network') }}/{{ lan_ipv4|ipaddr('prefix') }} rtable 1
match out on rdomain 1 to {{ wan_ipv4|ipaddr('address') }} rtable 0
{% if isp_netblocks is defined %}
{%   for isp_netblock in isp_netblocks|ipv4 %}
#match out on rdomain 1 to {{ isp_netblock }} rtable 0
{%   endfor %}
{% endif %}
pass quick on lo

block return log	# block stateless traffic
pass		# establish keep-state

# WAN_IF

match out on {{ wan_if }} inet from {{ lan_ipv4|ipaddr('network') }}/{{ lan_ipv4|ipaddr('prefix') }} nat-to {{ wan_ipv4|ipaddr('address') }}

block drop in log on {{ wan_if }}

#block drop in log quick on {{ wan_if }} inet from <bogons4>

pass in on {{ wan_if }} inet proto tcp to {{ wan_ipv4|ipaddr('address') }} port 22
pass in on {{ wan_if }} inet proto tcp to {{ wan_ipv4|ipaddr('address') }} port 53
pass in on {{ wan_if }} inet proto tcp to {{ wan_ipv4|ipaddr('address') }} port { 80 443 }
pass in on {{ wan_if }} inet proto udp to {{ wan_ipv4|ipaddr('address') }} port 53
#pass in on {{ wan_if }} inet proto udp to {{ wan_ipv4|ipaddr('address') }} port { 500 4500 }
pass in on {{ wan_if }} inet proto icmp to {{ wan_ipv4|ipaddr('address') }} icmp-type echoreq
#pass in on {{ wan_if }} inet proto esp to {{ wan_ipv4|ipaddr('address') }}

{% if wan_ipv6 is defined %}
#pass in on {{ wan_if }} inet6 proto tcp to {{ wan_ipv6|ipaddr('address') }} port 22
pass in on {{ wan_if }} inet6 proto tcp to {{ wan_ipv6|ipaddr('address') }} port 53
#pass in on {{ wan_if }} inet6 proto tcp to {{ wan_ipv6|ipaddr('address') }} port { 80 443 }
pass in on {{ wan_if }} inet6 proto udp to {{ wan_ipv6|ipaddr('address') }} port 53
pass in on {{ wan_if }} inet6 proto icmp6 to {{ wan_ipv6|ipaddr('address') }} icmp6-type echoreq
#pass in on {{ wan_if }} inet6 proto esp to {{ wan_ipv4|ipaddr('address') }}

{% endif %}
#pass in on {{ wan_if }} inet6 proto icmp6 from fe80::/16 to {{ wan_if }} icmp6-type routeradv
pass in on {{ wan_if }} inet6

# VPN_CLIENT_IF

block drop in log quick on {{ vpn_client_if }}

match out on {{ vpn_client_if }} inet \
  from {{ lan_ipv4|ipaddr('network') }}/{{ lan_ipv4|ipaddr('prefix') }} \
  nat-to ({{ vpn_client_if }}:0)

# LAN_IF

pass in on vether0 inet proto tcp \
  from {{ lan_ipv4|ipaddr('network') }}/{{ lan_ipv4|ipaddr('prefix') }} \
  to {{ lan_ipv4|ipaddr('address') }} port 22 \
  rdr-to {{ wan_ipv4|ipaddr('address') }} port 22
