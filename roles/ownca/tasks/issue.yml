---
- name: "{{ common_name }} : generate private key"
  delegate_to: localhost
  community.crypto.openssl_privatekey_pipe:
    content: "{{ privatekey_content }}"
    size: 2048
    return_current_key: true
  register: ownca_privatekey_result

- name: "{{ common_name }} : generate CSR"
  delegate_to: localhost
  community.crypto.openssl_csr_pipe:
    privatekey_content: "{{ ownca_privatekey_result.privatekey }}"
    common_name: "{{ common_name }}"
    subject_alt_name: "{{ subject_alt_name }}"
    basic_constraints:
      - CA:FALSE
    basic_constraints_critical: true
    key_usage:
      - digitalSignature
    key_usage_critical: true
  register: ownca_csr_result
  changed_when: false

- name: "{{ common_name }} : generate certificate"
  delegate_to: localhost
  community.crypto.x509_certificate_pipe:
    content: "{{ certificate_content }}"
    csr_content: "{{ ownca_csr_result.csr }}"
    provider: ownca
    ownca_content: "{{ hostvars.localhost.ownca_certificate }}"
    ownca_privatekey_content: "{{ hostvars.localhost.ownca_private_key }}"
    ownca_not_after: +800d # https://support.apple.com/en-us/HT210176
  register: ownca_certificate_result
