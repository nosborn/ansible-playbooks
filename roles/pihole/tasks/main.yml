# roles/pihole/tasks/main
---
- name: create persistent storage
  file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: 0755
    state: directory
  with_items:
    - /volume1/docker/{{ pihole_container_name }}/etc-dnsmasq.d
    - /volume1/docker/{{ pihole_container_name }}/etc-pihole

- template:
    src: "{{ item }}.j2"
    dest: /volume1/docker/{{ pihole_container_name }}/{{ item }}
    owner: root
    group: root
    mode: 0644
  with_items:
    - etc-dnsmasq.d/99-mediastreamer.conf
    - etc-pihole/adlists.list
    - etc-pihole/blacklist.txt
    - etc-pihole/whitelist.txt

- name: create container
  docker_container:
    name: "{{ pihole_container_name }}"
    comparisons:
      mac_address: ignore
    dns_servers:
      - 127.0.0.1
      - 1.1.1.1
    etc_hosts:
      mediastreamer-1: 85.203.37.1
      mediastreamer-2: 85.203.37.2
    env:
      CONDITIONAL_FORWARDING: "True"
      CONDITIONAL_FORWARDING_DOMAIN: localdomain
      CONDITIONAL_FORWARDING_IP: "{{ hostvars['usg']['lan_ipv4_address'] }}"
      CONDITIONAL_FORWARDING_REVERSE: 1.168.192.in-addr.arpa
      DNS1: 1.1.1.1
      DNS2: 1.0.0.1
      TZ: "{{ timezone }}"
      WEBPASSWORD: "{{ pihole_admin_password }}"
    image: "{{ pihole_image_name }}"
    mac_address: "02:42:c0:a8:01:c1"
    networks:
      - name: macvlan
        ipv4_address: "{{ pihole_ipv4_address }}"
    networks_cli_compatible: true
    restart_policy: unless-stopped
    volumes:
      - /volume1/docker/{{ pihole_container_name }}/etc-dnsmasq.d/:/etc/dnsmasq.d/
      - /volume1/docker/{{ pihole_container_name }}/etc-pihole/:/etc/pihole/
