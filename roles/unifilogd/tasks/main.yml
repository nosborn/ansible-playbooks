# roles/unilogd/tasks/main
---
- name: install dependencies
  package:
    name:
      - py3-aiohttp
      - py3-daemonize
      - py3-requests
      - py3-websocket-client
    state: present
  register: unifilogd_package_result
  until: unifilogd_package_result is succeeded

- name: install script
  template:
    src: unifilogd.py.j2
    dest: /usr/local/sbin/unifilogd
    owner: root
    group: wheel
    mode: 0550
    validate: /usr/local/bin/python3 -m py_compile %s
  notify: restart unifilogd

- name: install control script
  template:
    src: unifilogd.rc.j2
    dest: /etc/rc.d/unifilogd
    owner: root
    group: bin
    mode: 0555
    validate: /bin/ksh -n %s
  notify: restart unifilogd

- name: start service
  service:
    name: unifilogd
    enabled: true
    state: started
