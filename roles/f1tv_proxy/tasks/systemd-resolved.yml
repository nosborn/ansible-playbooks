# yamllint disable rule:line-length
---
- name: retrieve DNS servers
  ansible.builtin.uri:
    url: https://public-dns.info/nameserver/nz.json
    return_content: true
  register: f1tv_proxy_result

- ansible.builtin.template:
    src: resolved.conf.j2
    dest: /var/lib/machines/f1tv-proxy/etc/systemd/resolved.conf
    owner: root
    group: root
    mode: 0444
  vars:
    dns: "{{ f1tv_proxy_result.json | selectattr('dnssec') | selectattr('reliability', 'eq', 1) | map(attribute='ip') | join(' ') }}"
  notify: restart f1tv-proxy
