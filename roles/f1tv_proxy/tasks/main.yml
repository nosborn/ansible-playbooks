---
- name: install host packages
  ansible.builtin.apt:
    name: "{{ item }}"
    install_recommends: false
  loop:
    - debootstrap
    - systemd-container

- name: create machines directory
  ansible.builtin.file:
    path: /var/lib/machines
    owner: root
    group: root
    mode: 0700
    state: directory

- ansible.builtin.command:
    argv:
      - debootstrap
      - --include=dbus,nginx-light,systemd-resolved,wireguard-tools
      - bookworm
      - /var/lib/machines/f1tv-proxy
    creates: /var/lib/machines/f1tv-proxy/etc/os-release

- ansible.builtin.include_tasks: systemd-resolved.yml
- ansible.builtin.include_tasks: wireguard.yml

- name: enable and start proxy
  ansible.builtin.systemd:
    name: systemd-nspawn@f1tv-proxy.service
    enabled: true
    state: started

- name: restart proxy now
  ansible.builtin.meta: flush_handlers
#
# - name: enable and start services
#   become: true
#   become_method: machinectl
#   become_user: root
#   ansible.builtin.systemd:
#     name: systemd-resolved.service
#     enabled: true
#     state: started
