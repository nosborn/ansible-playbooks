# yamllint disable rule:line-length
---
- name: configure auto-upgrades
  ansible.builtin.debconf:
    name: unattended-upgrades
    question: "{{ unattended_upgrades_item.question }}"
    value: "{{ unattended_upgrades_item.value }}"
    vtype: "{{ unattended_upgrades_item.vtype }}"
  loop:
    - question: unattended-upgrades/enable_auto_updates
      value: !!str true
      vtype: boolean
  loop_control:
    label: "{{ unattended_upgrades_item.question }}"
    loop_var: unattended_upgrades_item

- name: install package
  ansible.builtin.apt:
    name:
      - apt-listchanges
      - unattended-upgrades
    install_recommends: false

- name: configure unattended-upgrades
  ansible.builtin.lineinfile:
    path: /etc/apt/apt.conf.d/50unattended-upgrades
    regexp: "{{ unattended_upgrades_item.regexp }}"
    line: "{{ unattended_upgrades_item.line }}"
  loop:
    - regexp: \bUnattended-Upgrade::Automatic-Reboot-Time\b
      line: Unattended-Upgrade::Automatic-Reboot-Time "{{ unattended_upgrade_automatic_reboot_time }}";
    - regexp: \bUnattended-Upgrade::Mail\b
      line: Unattended-Upgrade::Mail "{{ unattended_upgrade_mail }}";
    - regexp: \bUnattended-Upgrade::Remove-Unused-Dependencies\b
      line: Unattended-Upgrade::Remove-Unused-Dependencies "true";
  loop_control:
    label: "{{ unattended_upgrades_item.line }}"
    loop_var: unattended_upgrades_item
