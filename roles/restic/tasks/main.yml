---
- name: install restic
  ansible.builtin.apt:
    name: restic

- name: create restic configuration directory
  ansible.builtin.file:
    path: "{{ restic_config_dir }}"
    owner: root
    group: root
    mode: 0700
    state: directory

- name: configure restic environment
  ansible.builtin.copy:
    content: |
      B2_ACCOUNT_ID="{{ restic_b2_key_id }}"
      B2_ACCOUNT_KEY="{{ restic_b2_application_key }}"
      RESTIC_REPOSITORY="{{ restic_repository }}"
      RESTIC_PASSWORD_FILE="{{ restic_repository }}"
    dest: "{{ restic_config_dir }}/environment"
    owner: root
    group: root
    mode: 0400
    validate: sh -n %s

- name: configure restic password
  ansible.builtin.copy:
    content: |
      "{{ restic_password }}"
    dest: "{{ restic_password_file }}"
    owner: root
    group: root
    mode: 0400
